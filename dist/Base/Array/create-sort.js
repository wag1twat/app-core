"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const Types_1=require("../Types"),Guards_1=require("../../Guards"),Object_1=require("../Object"),createSort=c=>r=>{let d=!1;const{field:e,order:s,orders:a,onUpdate:t}=r,u={_collection:[],_order:Types_1.Types.Array.Sort.defaultOrder,_orders:Types_1.Types.Array.Sort.defaultOrders,_field:void 0},i=()=>{Guards_1.Guards.isFunc(t)&&t(u)};r=()=>{u._field=e||void 0,u._order=s||Types_1.Types.Array.Sort.defaultOrder,u._orders=a||Types_1.Types.Array.Sort.defaultOrders,u._collection=[...c],i()};const o=r=>{Guards_1.Guards.isUndefined(r)||(u._field=r)},l=(r,e)=>{let s=!1;e?Guards_1.Guards.isString(u._field)&&Guards_1.Guards.isString(r)?u._field===r&&(s=d):Guards_1.Guards.isString(u._field)&&Guards_1.Guards.isObject(r)?u._field===r.xpath&&(s=d):Guards_1.Guards.isObject(u._field)&&Guards_1.Guards.isString(r)?u._field.xpath===r&&(s=d):Guards_1.Guards.isObject(u._field)&&Guards_1.Guards.isObject(r)&&u._field.xpath===r.xpath&&(s=d):s=d,s&&(e=u._orders.length-1,r=u._orders.indexOf(u._order)+1,u._order=r<=e?u._orders[r]:u._orders[0])},G=()=>"default"===u._order&&(u._collection=[...c],i(),!0);var _=(r={})=>{var{field:r,noUpdateOrderFalsyEqualXPath:e=!1}=r;if(l(r,e),o(r),!G()){const a="ASC"===u._order,t=Guards_1.Guards.isString(u._field),_=Guards_1.Guards.isObject(u._field);u._collection=[...u._collection].sort((r,e)=>{let s=0;t?(r=r[u._field],e=e[u._field]):_&&(r=u._field.handler((0,Object_1.$Object)(r).getXPath(u._field.xpath)),e=u._field.handler((0,Object_1.$Object)(e).getXPath(u._field.xpath)));var d=Types_1.Types.Array.Sort.compareStrings(a,Guards_1.Guards.isString(r),Guards_1.Guards.isString(e),r,e),d=(Guards_1.Guards.isNumber(d)&&(s=d),Types_1.Types.Array.Sort.compareNumbers(a,Guards_1.Guards.isNumber(r),Guards_1.Guards.isNumber(e),r,e)),d=(Guards_1.Guards.isNumber(d)&&(s=d),Types_1.Types.Array.Sort.compareBooleans(a,Guards_1.Guards.isBoolean(r),Guards_1.Guards.isBoolean(e),r,e));return s=Guards_1.Guards.isNumber(d)?d:s}),i()}};return r(),d||(_({field:e}),d=!0),{cleanup:r,update:_}};exports.default=createSort;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkJhc2UvQXJyYXkvY3JlYXRlLXNvcnQuanMiLCIuLi9zcmMvQmFzZS9BcnJheS9jcmVhdGUtc29ydC50cyJdLCJuYW1lcyI6WyJPYmplY3QiLCJkZWZpbmVQcm9wZXJ0eSIsImV4cG9ydHMiLCJ2YWx1ZSIsIlR5cGVzXzEiLCJyZXF1aXJlIiwiR3VhcmRzXzEiLCJPYmplY3RfMSIsImNyZWF0ZVNvcnQiLCJjb2xsZWN0aW9uIiwib3B0aW9ucyIsImxldCIsImNhbGxlZCIsImZpZWxkIiwib3JkZXIiLCJvcmRlcnMiLCJvblVwZGF0ZSIsInN0YXRlIiwiX2NvbGxlY3Rpb24iLCJfb3JkZXIiLCJUeXBlcyIsIkFycmF5IiwiU29ydCIsImRlZmF1bHRPcmRlciIsIl9vcmRlcnMiLCJkZWZhdWx0T3JkZXJzIiwiX2ZpZWxkIiwidW5kZWZpbmVkIiwib25VcGRhdGVDYWxsYmFjayIsIkd1YXJkcyIsImlzRnVuYyIsImluc3RhbGwiLCJ1cGRhdGVGaWVsZCIsImlzVW5kZWZpbmVkIiwidXBkYXRlT3JkZXIiLCJub1VwZGF0ZU9yZGVyRmFsc3lFcXVhbFhQYXRoIiwiaXMiLCJpc1N0cmluZyIsImlzT2JqZWN0IiwieHBhdGgiLCJsYXN0T3JkZXJJbmRleCIsImxlbmd0aCIsIm5leHRPcmRlckluZGV4IiwiaW5kZXhPZiIsIm9uRGVmYXVsdE9yZGVyIiwidXBkYXRlIiwiaXNBc2MiLCJpc1N0cmluZ0ZpZWxkIiwiaXNPYmplY3RGaWVsZCIsInNvcnQiLCJsIiwiciIsIm4iLCJoYW5kbGVyIiwiJE9iamVjdCIsImdldFhQYXRoIiwic3RyaW5nc0NvbXBhcmF0aW9uIiwiY29tcGFyZVN0cmluZ3MiLCJudW1iZXJzQ29tcGFyYXRpb24iLCJpc051bWJlciIsImNvbXBhcmVOdW1iZXJzIiwiYm9vbGVhbkNvbXBhcmF0aW9uIiwiY29tcGFyZUJvb2xlYW5zIiwiaXNCb29sZWFuIiwiY2xlYW51cCIsImRlZmF1bHQiXSwibWFwcGluZ3MiOiJBQUFBLGFBQ0FBLE9BQU9DLGVBQWVDLFFBQVMsYUFBYyxDQUFFQyxNQUFPLENBQUEsQ0FBSyxDQUFDLEVDRDVELE1BQUFDLFFBQUFDLFFBQUEsVUFBQSxFQUNBQyxTQUFBRCxRQUFBLGNBQUEsRUFDQUUsU0FBQUYsUUFBQSxXQUFBLEVBRU1HLFdBQ2dCQyxHQUVkQyxJQUVBQyxJQUFJQyxFQUFrQixDQUFBLEVBRXRCLEtBQU0sQ0FBRUMsTUFBQUEsRUFBT0MsTUFBQUEsRUFBT0MsT0FBQUEsRUFBUUMsU0FBQUEsQ0FBUSxFQUFLTixFQUVyQ08sRUFBbUMsQ0FDckNDLFlBQWEsR0FDYkMsT0FBUWYsUUFBQWdCLE1BQU1DLE1BQU1DLEtBQUtDLGFBQ3pCQyxRQUFTcEIsUUFBQWdCLE1BQU1DLE1BQU1DLEtBQUtHLGNBQzFCQyxPQUFRQyxLQUFBQSxDQU5VWixFQVNoQmEsRUFBbUJBLEtBQ2pCdEIsU0FBQXVCLE9BQU9DLE9BQU9kLENBQVEsR0FDdEJBLEVBQVNDLENBQUssQ0FFdEIsRUFFTWMsRUFBVUEsS0FDWmQsRUFBTVMsT0FBU2IsR0FBZ0JjLEtBQUFBLEVBQy9CVixFQUFNRSxPQUFTTCxHQUFnQlYsUUFBQWdCLE1BQU1DLE1BQU1DLEtBQUtDLGFBQ2hETixFQUFNTyxRQUFVVCxHQUFrQlgsUUFBQWdCLE1BQU1DLE1BQU1DLEtBQUtHLGNBQ25EUixFQUFNQyxZQUFjLENBQUMsR0FBR1QsR0FDeEJtQixFQUFnQixDQUNwQixFQUVBLE1BQU1JLEVBQ0ZuQixJQUVLUCxTQUFBdUIsT0FBT0ksWUFBWXBCLENBQUssSUFDekJJLEVBQU1TLE9BQVNiLEVBRXZCLEVBRU1xQixFQUFjQSxDQUNoQnJCLEVBQ0FzQixLQUVBeEIsSUFBSXlCLEVBQWMsQ0FBQSxFQUVkRCxFQUNJN0IsU0FBQXVCLE9BQU9RLFNBQVNwQixFQUFNUyxNQUFNLEdBQUtwQixTQUFBdUIsT0FBT1EsU0FBU3hCLENBQUssRUFDbERJLEVBQU1TLFNBQVdiLElBQ2pCdUIsRUFBYXhCLEdBRVZOLFNBQUF1QixPQUFPUSxTQUFTcEIsRUFBTVMsTUFBTSxHQUFLcEIsU0FBQXVCLE9BQU9TLFNBQVN6QixDQUFLLEVBQ3pESSxFQUFNUyxTQUFXYixFQUFNMEIsUUFDdkJILEVBQWF4QixHQUVWTixTQUFBdUIsT0FBT1MsU0FBU3JCLEVBQU1TLE1BQU0sR0FBS3BCLFNBQUF1QixPQUFPUSxTQUFTeEIsQ0FBSyxFQUN6REksRUFBTVMsT0FBT2EsUUFBVTFCLElBQ3ZCdUIsRUFBYXhCLEdBRVZOLFNBQUF1QixPQUFPUyxTQUFTckIsRUFBTVMsTUFBTSxHQUFLcEIsU0FBQXVCLE9BQU9TLFNBQVN6QixDQUFLLEdBQ3pESSxFQUFNUyxPQUFPYSxRQUFVMUIsRUFBTTBCLFFBQzdCSCxFQUFheEIsR0FJckJ3QixFQUFheEIsRUFHYndCLElBQ01JLEVBQWlCdkIsRUFBTU8sUUFBUWlCLE9BQVMsRUFFeENDLEVBRG9CekIsRUFBTU8sUUFBUW1CLFFBQVExQixFQUFNRSxNQUFNLEVBQ2pCLEVBQzNDRixFQUFNRSxPQUNGdUIsR0FBa0JGLEVBQ1p2QixFQUFNTyxRQUFRa0IsR0FDZHpCLEVBQU1PLFFBQVEsR0FFaEMsRUFFTW9CLEVBQWlCQSxJQUNFLFlBQWpCM0IsRUFBTUUsU0FDTkYsRUFBTUMsWUFBYyxDQUFDLEdBQUdULEdBRXhCbUIsRUFBZ0IsRUFFVCxDQUFBLEdBS2YsSUFBTWlCLEVBQVNBLENBQ1huQyxFQUFvRCxNQUVwRCxHQUFNLENBQUVHLE1BQUFBLEVBQU9zQiw2QkFBQUEsRUFBK0IsQ0FBQSxDQUFLLEVBQUt6QixFQU14RCxHQUpBd0IsRUFBWXJCLEVBQU9zQixDQUE0QixFQUUvQ0gsRUFBWW5CLENBQUssRUFFYixDQUFDK0IsRUFBYyxFQUFJLENBQ25CLE1BQU1FLEVBQXlCLFFBQWpCN0IsRUFBTUUsT0FDZDRCLEVBQWdCekMsU0FBQXVCLE9BQU9RLFNBQVNwQixFQUFNUyxNQUFNLEVBQzVDc0IsRUFBZ0IxQyxTQUFBdUIsT0FBT1MsU0FBU3JCLEVBQU1TLE1BQU0sRUFFbERULEVBQU1DLFlBQWUsQ0FBQyxHQUFHRCxFQUFNQyxhQUFtQitCLEtBQUssQ0FBQ0MsRUFBR0MsS0FDdkR4QyxJQUFJeUMsRUFBSSxFQUVKTCxHQUNBRyxFQUFJQSxFQUFFakMsRUFBTVMsUUFDWnlCLEVBQUlBLEVBQUVsQyxFQUFNUyxTQUNMc0IsSUFDUEUsRUFBS2pDLEVBQU1TLE9BQWtEMkIsU0FDekQsRUFBQTlDLFNBQUErQyxTQUFRSixDQUFDLEVBQUVLLFNBQ050QyxFQUFNUyxPQUFrRGEsS0FBSyxDQUNqRSxFQUVMWSxFQUFLbEMsRUFBTVMsT0FBa0QyQixTQUN6RCxFQUFBOUMsU0FBQStDLFNBQVFILENBQUMsRUFBRUksU0FDTnRDLEVBQU1TLE9BQWtEYSxLQUFLLENBQ2pFLEdBSVQsSUFBTWlCLEVBQXFCcEQsUUFBQWdCLE1BQU1DLE1BQU1DLEtBQUttQyxlQUN4Q1gsRUFDQXhDLFNBQUF1QixPQUFPUSxTQUFTYSxDQUFDLEVBQ2pCNUMsU0FBQXVCLE9BQU9RLFNBQVNjLENBQUMsRUFDakJELEVBQ0FDLENBQUMsRUFPQ08sR0FKRnBELFNBQUF1QixPQUFPOEIsU0FBU0gsQ0FBa0IsSUFDbENKLEVBQUlJLEdBR21CcEQsUUFBQWdCLE1BQU1DLE1BQU1DLEtBQUtzQyxlQUN4Q2QsRUFDQXhDLFNBQUF1QixPQUFPOEIsU0FBU1QsQ0FBQyxFQUNqQjVDLFNBQUF1QixPQUFPOEIsU0FBU1IsQ0FBQyxFQUNqQkQsRUFDQUMsQ0FBQyxHQU9DVSxHQUpGdkQsU0FBQXVCLE9BQU84QixTQUFTRCxDQUFrQixJQUNsQ04sRUFBSU0sR0FHbUJ0RCxRQUFBZ0IsTUFBTUMsTUFBTUMsS0FBS3dDLGdCQUN4Q2hCLEVBQ0F4QyxTQUFBdUIsT0FBT2tDLFVBQVViLENBQUMsRUFDbEI1QyxTQUFBdUIsT0FBT2tDLFVBQVVaLENBQUMsRUFDbEJELEVBQ0FDLENBQUMsR0FPTCxPQUhJQyxFQURBOUMsU0FBQXVCLE9BQU84QixTQUFTRSxDQUFrQixFQUM5QkEsRUFHRFQsQ0FDWCxDQUFDLEVBRUR4QixFQUFnQixDQUhaLENBS1osRUFXQSxPQVRBRyxFQUFPLEVBRUZuQixJQUNEaUMsRUFBTyxDQUNIaEMsTUFBQUEsQ0FGSEQsQ0FHQSxFQUNEQSxFQUFTLENBQUEsR0FHTixDQUNIb0QsUUFBU2pDLEVBQ1RjLE9BQUFBLENBRkosQ0FJSixFQUVKM0MsUUFBQStELFFBQWV6RCIsImZpbGUiOiJCYXNlL0FycmF5L2NyZWF0ZS1zb3J0LmpzIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgXCJfX2VzTW9kdWxlXCIsIHsgdmFsdWU6IHRydWUgfSk7XG5jb25zdCBUeXBlc18xID0gcmVxdWlyZShcIi4uL1R5cGVzXCIpO1xuY29uc3QgR3VhcmRzXzEgPSByZXF1aXJlKFwiLi4vLi4vR3VhcmRzXCIpO1xuY29uc3QgT2JqZWN0XzEgPSByZXF1aXJlKFwiLi4vT2JqZWN0XCIpO1xuY29uc3QgY3JlYXRlU29ydCA9IChjb2xsZWN0aW9uKSA9PiAob3B0aW9ucykgPT4ge1xuICAgIGxldCBjYWxsZWQgPSBmYWxzZTtcbiAgICBjb25zdCB7IGZpZWxkLCBvcmRlciwgb3JkZXJzLCBvblVwZGF0ZSB9ID0gb3B0aW9ucztcbiAgICBjb25zdCBzdGF0ZSA9IHtcbiAgICAgICAgX2NvbGxlY3Rpb246IFtdLFxuICAgICAgICBfb3JkZXI6IFR5cGVzXzEuVHlwZXMuQXJyYXkuU29ydC5kZWZhdWx0T3JkZXIsXG4gICAgICAgIF9vcmRlcnM6IFR5cGVzXzEuVHlwZXMuQXJyYXkuU29ydC5kZWZhdWx0T3JkZXJzLFxuICAgICAgICBfZmllbGQ6IHVuZGVmaW5lZCxcbiAgICB9O1xuICAgIGNvbnN0IG9uVXBkYXRlQ2FsbGJhY2sgPSAoKSA9PiB7XG4gICAgICAgIGlmIChHdWFyZHNfMS5HdWFyZHMuaXNGdW5jKG9uVXBkYXRlKSkge1xuICAgICAgICAgICAgb25VcGRhdGUoc3RhdGUpO1xuICAgICAgICB9XG4gICAgfTtcbiAgICBjb25zdCBpbnN0YWxsID0gKCkgPT4ge1xuICAgICAgICBzdGF0ZS5fZmllbGQgPSBmaWVsZCA/IGZpZWxkIDogdW5kZWZpbmVkO1xuICAgICAgICBzdGF0ZS5fb3JkZXIgPSBvcmRlciA/IG9yZGVyIDogVHlwZXNfMS5UeXBlcy5BcnJheS5Tb3J0LmRlZmF1bHRPcmRlcjtcbiAgICAgICAgc3RhdGUuX29yZGVycyA9IG9yZGVycyA/IG9yZGVycyA6IFR5cGVzXzEuVHlwZXMuQXJyYXkuU29ydC5kZWZhdWx0T3JkZXJzO1xuICAgICAgICBzdGF0ZS5fY29sbGVjdGlvbiA9IFsuLi5jb2xsZWN0aW9uXTtcbiAgICAgICAgb25VcGRhdGVDYWxsYmFjaygpO1xuICAgIH07XG4gICAgY29uc3QgdXBkYXRlRmllbGQgPSAoZmllbGQpID0+IHtcbiAgICAgICAgaWYgKCFHdWFyZHNfMS5HdWFyZHMuaXNVbmRlZmluZWQoZmllbGQpKSB7XG4gICAgICAgICAgICBzdGF0ZS5fZmllbGQgPSBmaWVsZDtcbiAgICAgICAgfVxuICAgIH07XG4gICAgY29uc3QgdXBkYXRlT3JkZXIgPSAoZmllbGQsIG5vVXBkYXRlT3JkZXJGYWxzeUVxdWFsWFBhdGgpID0+IHtcbiAgICAgICAgbGV0IGlzID0gZmFsc2U7XG4gICAgICAgIGlmIChub1VwZGF0ZU9yZGVyRmFsc3lFcXVhbFhQYXRoKSB7XG4gICAgICAgICAgICBpZiAoR3VhcmRzXzEuR3VhcmRzLmlzU3RyaW5nKHN0YXRlLl9maWVsZCkgJiYgR3VhcmRzXzEuR3VhcmRzLmlzU3RyaW5nKGZpZWxkKSkge1xuICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5fZmllbGQgPT09IGZpZWxkKSB7XG4gICAgICAgICAgICAgICAgICAgIGlzID0gdHJ1ZSAmJiBjYWxsZWQ7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSBpZiAoR3VhcmRzXzEuR3VhcmRzLmlzU3RyaW5nKHN0YXRlLl9maWVsZCkgJiYgR3VhcmRzXzEuR3VhcmRzLmlzT2JqZWN0KGZpZWxkKSkge1xuICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5fZmllbGQgPT09IGZpZWxkLnhwYXRoKSB7XG4gICAgICAgICAgICAgICAgICAgIGlzID0gdHJ1ZSAmJiBjYWxsZWQ7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSBpZiAoR3VhcmRzXzEuR3VhcmRzLmlzT2JqZWN0KHN0YXRlLl9maWVsZCkgJiYgR3VhcmRzXzEuR3VhcmRzLmlzU3RyaW5nKGZpZWxkKSkge1xuICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5fZmllbGQueHBhdGggPT09IGZpZWxkKSB7XG4gICAgICAgICAgICAgICAgICAgIGlzID0gdHJ1ZSAmJiBjYWxsZWQ7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSBpZiAoR3VhcmRzXzEuR3VhcmRzLmlzT2JqZWN0KHN0YXRlLl9maWVsZCkgJiYgR3VhcmRzXzEuR3VhcmRzLmlzT2JqZWN0KGZpZWxkKSkge1xuICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5fZmllbGQueHBhdGggPT09IGZpZWxkLnhwYXRoKSB7XG4gICAgICAgICAgICAgICAgICAgIGlzID0gdHJ1ZSAmJiBjYWxsZWQ7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgaXMgPSB0cnVlICYmIGNhbGxlZDtcbiAgICAgICAgfVxuICAgICAgICBpZiAoaXMpIHtcbiAgICAgICAgICAgIGNvbnN0IGxhc3RPcmRlckluZGV4ID0gc3RhdGUuX29yZGVycy5sZW5ndGggLSAxO1xuICAgICAgICAgICAgY29uc3QgY3VycmVudE9yZGVySW5kZXggPSBzdGF0ZS5fb3JkZXJzLmluZGV4T2Yoc3RhdGUuX29yZGVyKTtcbiAgICAgICAgICAgIGNvbnN0IG5leHRPcmRlckluZGV4ID0gY3VycmVudE9yZGVySW5kZXggKyAxO1xuICAgICAgICAgICAgc3RhdGUuX29yZGVyID1cbiAgICAgICAgICAgICAgICBuZXh0T3JkZXJJbmRleCA8PSBsYXN0T3JkZXJJbmRleFxuICAgICAgICAgICAgICAgICAgICA/IHN0YXRlLl9vcmRlcnNbbmV4dE9yZGVySW5kZXhdXG4gICAgICAgICAgICAgICAgICAgIDogc3RhdGUuX29yZGVyc1swXTtcbiAgICAgICAgfVxuICAgIH07XG4gICAgY29uc3Qgb25EZWZhdWx0T3JkZXIgPSAoKSA9PiB7XG4gICAgICAgIGlmIChzdGF0ZS5fb3JkZXIgPT09ICdkZWZhdWx0Jykge1xuICAgICAgICAgICAgc3RhdGUuX2NvbGxlY3Rpb24gPSBbLi4uY29sbGVjdGlvbl07XG4gICAgICAgICAgICBvblVwZGF0ZUNhbGxiYWNrKCk7XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfTtcbiAgICBjb25zdCB1cGRhdGUgPSAob3B0aW9ucyA9IHt9KSA9PiB7XG4gICAgICAgIGNvbnN0IHsgZmllbGQsIG5vVXBkYXRlT3JkZXJGYWxzeUVxdWFsWFBhdGggPSBmYWxzZSB9ID0gb3B0aW9ucztcbiAgICAgICAgdXBkYXRlT3JkZXIoZmllbGQsIG5vVXBkYXRlT3JkZXJGYWxzeUVxdWFsWFBhdGgpO1xuICAgICAgICB1cGRhdGVGaWVsZChmaWVsZCk7XG4gICAgICAgIGlmICghb25EZWZhdWx0T3JkZXIoKSkge1xuICAgICAgICAgICAgY29uc3QgaXNBc2MgPSBzdGF0ZS5fb3JkZXIgPT09ICdBU0MnO1xuICAgICAgICAgICAgY29uc3QgaXNTdHJpbmdGaWVsZCA9IEd1YXJkc18xLkd1YXJkcy5pc1N0cmluZyhzdGF0ZS5fZmllbGQpO1xuICAgICAgICAgICAgY29uc3QgaXNPYmplY3RGaWVsZCA9IEd1YXJkc18xLkd1YXJkcy5pc09iamVjdChzdGF0ZS5fZmllbGQpO1xuICAgICAgICAgICAgc3RhdGUuX2NvbGxlY3Rpb24gPSBbLi4uc3RhdGUuX2NvbGxlY3Rpb25dLnNvcnQoKGwsIHIpID0+IHtcbiAgICAgICAgICAgICAgICBsZXQgbiA9IDA7XG4gICAgICAgICAgICAgICAgaWYgKGlzU3RyaW5nRmllbGQpIHtcbiAgICAgICAgICAgICAgICAgICAgbCA9IGxbc3RhdGUuX2ZpZWxkXTtcbiAgICAgICAgICAgICAgICAgICAgciA9IHJbc3RhdGUuX2ZpZWxkXTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSBpZiAoaXNPYmplY3RGaWVsZCkge1xuICAgICAgICAgICAgICAgICAgICBsID0gc3RhdGUuX2ZpZWxkLmhhbmRsZXIoKDAsIE9iamVjdF8xLiRPYmplY3QpKGwpLmdldFhQYXRoKHN0YXRlLl9maWVsZC54cGF0aCkpO1xuICAgICAgICAgICAgICAgICAgICByID0gc3RhdGUuX2ZpZWxkLmhhbmRsZXIoKDAsIE9iamVjdF8xLiRPYmplY3QpKHIpLmdldFhQYXRoKHN0YXRlLl9maWVsZC54cGF0aCkpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBjb25zdCBzdHJpbmdzQ29tcGFyYXRpb24gPSBUeXBlc18xLlR5cGVzLkFycmF5LlNvcnQuY29tcGFyZVN0cmluZ3MoaXNBc2MsIEd1YXJkc18xLkd1YXJkcy5pc1N0cmluZyhsKSwgR3VhcmRzXzEuR3VhcmRzLmlzU3RyaW5nKHIpLCBsLCByKTtcbiAgICAgICAgICAgICAgICBpZiAoR3VhcmRzXzEuR3VhcmRzLmlzTnVtYmVyKHN0cmluZ3NDb21wYXJhdGlvbikpIHtcbiAgICAgICAgICAgICAgICAgICAgbiA9IHN0cmluZ3NDb21wYXJhdGlvbjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgY29uc3QgbnVtYmVyc0NvbXBhcmF0aW9uID0gVHlwZXNfMS5UeXBlcy5BcnJheS5Tb3J0LmNvbXBhcmVOdW1iZXJzKGlzQXNjLCBHdWFyZHNfMS5HdWFyZHMuaXNOdW1iZXIobCksIEd1YXJkc18xLkd1YXJkcy5pc051bWJlcihyKSwgbCwgcik7XG4gICAgICAgICAgICAgICAgaWYgKEd1YXJkc18xLkd1YXJkcy5pc051bWJlcihudW1iZXJzQ29tcGFyYXRpb24pKSB7XG4gICAgICAgICAgICAgICAgICAgIG4gPSBudW1iZXJzQ29tcGFyYXRpb247XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGNvbnN0IGJvb2xlYW5Db21wYXJhdGlvbiA9IFR5cGVzXzEuVHlwZXMuQXJyYXkuU29ydC5jb21wYXJlQm9vbGVhbnMoaXNBc2MsIEd1YXJkc18xLkd1YXJkcy5pc0Jvb2xlYW4obCksIEd1YXJkc18xLkd1YXJkcy5pc0Jvb2xlYW4ociksIGwsIHIpO1xuICAgICAgICAgICAgICAgIGlmIChHdWFyZHNfMS5HdWFyZHMuaXNOdW1iZXIoYm9vbGVhbkNvbXBhcmF0aW9uKSkge1xuICAgICAgICAgICAgICAgICAgICBuID0gYm9vbGVhbkNvbXBhcmF0aW9uO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gbjtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgb25VcGRhdGVDYWxsYmFjaygpO1xuICAgICAgICB9XG4gICAgfTtcbiAgICBpbnN0YWxsKCk7XG4gICAgaWYgKCFjYWxsZWQpIHtcbiAgICAgICAgdXBkYXRlKHtcbiAgICAgICAgICAgIGZpZWxkLFxuICAgICAgICB9KTtcbiAgICAgICAgY2FsbGVkID0gdHJ1ZTtcbiAgICB9XG4gICAgcmV0dXJuIHtcbiAgICAgICAgY2xlYW51cDogaW5zdGFsbCxcbiAgICAgICAgdXBkYXRlLFxuICAgIH07XG59O1xuZXhwb3J0cy5kZWZhdWx0ID0gY3JlYXRlU29ydDtcbiIsImltcG9ydCB7IFR5cGVzIH0gZnJvbSAnLi4vVHlwZXMnXG5pbXBvcnQgeyBHdWFyZHMgfSBmcm9tICcuLi8uLi9HdWFyZHMnXG5pbXBvcnQgeyAkT2JqZWN0IH0gZnJvbSAnLi4vT2JqZWN0J1xuXG5jb25zdCBjcmVhdGVTb3J0ID1cbiAgICA8VCBleHRlbmRzIGFueVtdPihjb2xsZWN0aW9uOiBUKSA9PlxuICAgIDxYUGF0aCBleHRlbmRzIFR5cGVzLlV0aWxpdHkuSlNPTlBhdGg8VHlwZXMuQXJyYXkuT2Y8VD4+PihcbiAgICAgICAgb3B0aW9uczogVHlwZXMuQXJyYXkuU29ydC5PcHRpb25zPFQsIFhQYXRoPlxuICAgICkgPT4ge1xuICAgICAgICBsZXQgY2FsbGVkOiBib29sZWFuID0gZmFsc2VcblxuICAgICAgICBjb25zdCB7IGZpZWxkLCBvcmRlciwgb3JkZXJzLCBvblVwZGF0ZSB9ID0gb3B0aW9uc1xuXG4gICAgICAgIGNvbnN0IHN0YXRlOiBUeXBlcy5BcnJheS5Tb3J0LlN0YXRlPFQ+ID0ge1xuICAgICAgICAgICAgX2NvbGxlY3Rpb246IFtdIGFzIHVua25vd24gYXMgVCxcbiAgICAgICAgICAgIF9vcmRlcjogVHlwZXMuQXJyYXkuU29ydC5kZWZhdWx0T3JkZXIsXG4gICAgICAgICAgICBfb3JkZXJzOiBUeXBlcy5BcnJheS5Tb3J0LmRlZmF1bHRPcmRlcnMsXG4gICAgICAgICAgICBfZmllbGQ6IHVuZGVmaW5lZCxcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IG9uVXBkYXRlQ2FsbGJhY2sgPSAoKSA9PiB7XG4gICAgICAgICAgICBpZiAoR3VhcmRzLmlzRnVuYyhvblVwZGF0ZSkpIHtcbiAgICAgICAgICAgICAgICBvblVwZGF0ZShzdGF0ZSlcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGluc3RhbGwgPSAoKSA9PiB7XG4gICAgICAgICAgICBzdGF0ZS5fZmllbGQgPSBmaWVsZCA/IGZpZWxkIDogdW5kZWZpbmVkXG4gICAgICAgICAgICBzdGF0ZS5fb3JkZXIgPSBvcmRlciA/IG9yZGVyIDogVHlwZXMuQXJyYXkuU29ydC5kZWZhdWx0T3JkZXJcbiAgICAgICAgICAgIHN0YXRlLl9vcmRlcnMgPSBvcmRlcnMgPyBvcmRlcnMgOiBUeXBlcy5BcnJheS5Tb3J0LmRlZmF1bHRPcmRlcnNcbiAgICAgICAgICAgIHN0YXRlLl9jb2xsZWN0aW9uID0gWy4uLmNvbGxlY3Rpb25dIGFzIFRcbiAgICAgICAgICAgIG9uVXBkYXRlQ2FsbGJhY2soKVxuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgdXBkYXRlRmllbGQgPSA8WFBhdGggZXh0ZW5kcyBUeXBlcy5VdGlsaXR5LkpTT05QYXRoPFR5cGVzLkFycmF5Lk9mPFQ+Pj4oXG4gICAgICAgICAgICBmaWVsZDogVHlwZXMuQXJyYXkuU29ydC5GaWVsZDxULCBYUGF0aD4gfCB1bmRlZmluZWRcbiAgICAgICAgKSA9PiB7XG4gICAgICAgICAgICBpZiAoIUd1YXJkcy5pc1VuZGVmaW5lZChmaWVsZCkpIHtcbiAgICAgICAgICAgICAgICBzdGF0ZS5fZmllbGQgPSBmaWVsZFxuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgdXBkYXRlT3JkZXIgPSA8WFBhdGggZXh0ZW5kcyBUeXBlcy5VdGlsaXR5LkpTT05QYXRoPFR5cGVzLkFycmF5Lk9mPFQ+Pj4oXG4gICAgICAgICAgICBmaWVsZDogVHlwZXMuQXJyYXkuU29ydC5GaWVsZDxULCBYUGF0aD4gfCB1bmRlZmluZWQsXG4gICAgICAgICAgICBub1VwZGF0ZU9yZGVyRmFsc3lFcXVhbFhQYXRoOiBib29sZWFuXG4gICAgICAgICkgPT4ge1xuICAgICAgICAgICAgbGV0IGlzOiBib29sZWFuID0gZmFsc2VcblxuICAgICAgICAgICAgaWYgKG5vVXBkYXRlT3JkZXJGYWxzeUVxdWFsWFBhdGgpIHtcbiAgICAgICAgICAgICAgICBpZiAoR3VhcmRzLmlzU3RyaW5nKHN0YXRlLl9maWVsZCkgJiYgR3VhcmRzLmlzU3RyaW5nKGZpZWxkKSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoc3RhdGUuX2ZpZWxkID09PSBmaWVsZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaXMgPSB0cnVlICYmIGNhbGxlZFxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChHdWFyZHMuaXNTdHJpbmcoc3RhdGUuX2ZpZWxkKSAmJiBHdWFyZHMuaXNPYmplY3QoZmllbGQpKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5fZmllbGQgPT09IGZpZWxkLnhwYXRoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpcyA9IHRydWUgJiYgY2FsbGVkXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKEd1YXJkcy5pc09iamVjdChzdGF0ZS5fZmllbGQpICYmIEd1YXJkcy5pc1N0cmluZyhmaWVsZCkpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLl9maWVsZC54cGF0aCA9PT0gZmllbGQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlzID0gdHJ1ZSAmJiBjYWxsZWRcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoR3VhcmRzLmlzT2JqZWN0KHN0YXRlLl9maWVsZCkgJiYgR3VhcmRzLmlzT2JqZWN0KGZpZWxkKSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoc3RhdGUuX2ZpZWxkLnhwYXRoID09PSBmaWVsZC54cGF0aCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaXMgPSB0cnVlICYmIGNhbGxlZFxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBpcyA9IHRydWUgJiYgY2FsbGVkXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChpcykge1xuICAgICAgICAgICAgICAgIGNvbnN0IGxhc3RPcmRlckluZGV4ID0gc3RhdGUuX29yZGVycy5sZW5ndGggLSAxXG4gICAgICAgICAgICAgICAgY29uc3QgY3VycmVudE9yZGVySW5kZXggPSBzdGF0ZS5fb3JkZXJzLmluZGV4T2Yoc3RhdGUuX29yZGVyKVxuICAgICAgICAgICAgICAgIGNvbnN0IG5leHRPcmRlckluZGV4ID0gY3VycmVudE9yZGVySW5kZXggKyAxXG4gICAgICAgICAgICAgICAgc3RhdGUuX29yZGVyID1cbiAgICAgICAgICAgICAgICAgICAgbmV4dE9yZGVySW5kZXggPD0gbGFzdE9yZGVySW5kZXhcbiAgICAgICAgICAgICAgICAgICAgICAgID8gc3RhdGUuX29yZGVyc1tuZXh0T3JkZXJJbmRleF1cbiAgICAgICAgICAgICAgICAgICAgICAgIDogc3RhdGUuX29yZGVyc1swXVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgY29uc3Qgb25EZWZhdWx0T3JkZXIgPSAoKSA9PiB7XG4gICAgICAgICAgICBpZiAoc3RhdGUuX29yZGVyID09PSAnZGVmYXVsdCcpIHtcbiAgICAgICAgICAgICAgICBzdGF0ZS5fY29sbGVjdGlvbiA9IFsuLi5jb2xsZWN0aW9uXSBhcyBUXG5cbiAgICAgICAgICAgICAgICBvblVwZGF0ZUNhbGxiYWNrKClcblxuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gZmFsc2VcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHVwZGF0ZSA9IDxYUGF0aCBleHRlbmRzIFR5cGVzLlV0aWxpdHkuSlNPTlBhdGg8VHlwZXMuQXJyYXkuT2Y8VD4+PihcbiAgICAgICAgICAgIG9wdGlvbnM6IFR5cGVzLkFycmF5LlNvcnQuVXBkYXRlT3B0aW9uczxULCBYUGF0aD4gPSB7fVxuICAgICAgICApID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHsgZmllbGQsIG5vVXBkYXRlT3JkZXJGYWxzeUVxdWFsWFBhdGggPSBmYWxzZSB9ID0gb3B0aW9uc1xuXG4gICAgICAgICAgICB1cGRhdGVPcmRlcihmaWVsZCwgbm9VcGRhdGVPcmRlckZhbHN5RXF1YWxYUGF0aClcblxuICAgICAgICAgICAgdXBkYXRlRmllbGQoZmllbGQpXG5cbiAgICAgICAgICAgIGlmICghb25EZWZhdWx0T3JkZXIoKSkge1xuICAgICAgICAgICAgICAgIGNvbnN0IGlzQXNjID0gc3RhdGUuX29yZGVyID09PSAnQVNDJ1xuICAgICAgICAgICAgICAgIGNvbnN0IGlzU3RyaW5nRmllbGQgPSBHdWFyZHMuaXNTdHJpbmcoc3RhdGUuX2ZpZWxkKVxuICAgICAgICAgICAgICAgIGNvbnN0IGlzT2JqZWN0RmllbGQgPSBHdWFyZHMuaXNPYmplY3Qoc3RhdGUuX2ZpZWxkKVxuXG4gICAgICAgICAgICAgICAgc3RhdGUuX2NvbGxlY3Rpb24gPSAoWy4uLnN0YXRlLl9jb2xsZWN0aW9uXSBhcyBUKS5zb3J0KChsLCByKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGxldCBuID0gMFxuXG4gICAgICAgICAgICAgICAgICAgIGlmIChpc1N0cmluZ0ZpZWxkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBsID0gbFtzdGF0ZS5fZmllbGRdXG4gICAgICAgICAgICAgICAgICAgICAgICByID0gcltzdGF0ZS5fZmllbGRdXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNPYmplY3RGaWVsZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgbCA9IChzdGF0ZS5fZmllbGQgYXMgVHlwZXMuQXJyYXkuU29ydC5GaWVsZE9iamVjdDxULCBYUGF0aD4pLmhhbmRsZXIoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJE9iamVjdChsKS5nZXRYUGF0aChcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKHN0YXRlLl9maWVsZCBhcyBUeXBlcy5BcnJheS5Tb3J0LkZpZWxkT2JqZWN0PFQsIFhQYXRoPikueHBhdGhcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgICAgICAgICByID0gKHN0YXRlLl9maWVsZCBhcyBUeXBlcy5BcnJheS5Tb3J0LkZpZWxkT2JqZWN0PFQsIFhQYXRoPikuaGFuZGxlcihcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkT2JqZWN0KHIpLmdldFhQYXRoKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoc3RhdGUuX2ZpZWxkIGFzIFR5cGVzLkFycmF5LlNvcnQuRmllbGRPYmplY3Q8VCwgWFBhdGg+KS54cGF0aFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHN0cmluZ3NDb21wYXJhdGlvbiA9IFR5cGVzLkFycmF5LlNvcnQuY29tcGFyZVN0cmluZ3MoXG4gICAgICAgICAgICAgICAgICAgICAgICBpc0FzYyxcbiAgICAgICAgICAgICAgICAgICAgICAgIEd1YXJkcy5pc1N0cmluZyhsKSxcbiAgICAgICAgICAgICAgICAgICAgICAgIEd1YXJkcy5pc1N0cmluZyhyKSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGwsXG4gICAgICAgICAgICAgICAgICAgICAgICByXG4gICAgICAgICAgICAgICAgICAgIClcblxuICAgICAgICAgICAgICAgICAgICBpZiAoR3VhcmRzLmlzTnVtYmVyKHN0cmluZ3NDb21wYXJhdGlvbikpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG4gPSBzdHJpbmdzQ29tcGFyYXRpb25cbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IG51bWJlcnNDb21wYXJhdGlvbiA9IFR5cGVzLkFycmF5LlNvcnQuY29tcGFyZU51bWJlcnMoXG4gICAgICAgICAgICAgICAgICAgICAgICBpc0FzYyxcbiAgICAgICAgICAgICAgICAgICAgICAgIEd1YXJkcy5pc051bWJlcihsKSxcbiAgICAgICAgICAgICAgICAgICAgICAgIEd1YXJkcy5pc051bWJlcihyKSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGwsXG4gICAgICAgICAgICAgICAgICAgICAgICByXG4gICAgICAgICAgICAgICAgICAgIClcblxuICAgICAgICAgICAgICAgICAgICBpZiAoR3VhcmRzLmlzTnVtYmVyKG51bWJlcnNDb21wYXJhdGlvbikpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG4gPSBudW1iZXJzQ29tcGFyYXRpb25cbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGJvb2xlYW5Db21wYXJhdGlvbiA9IFR5cGVzLkFycmF5LlNvcnQuY29tcGFyZUJvb2xlYW5zKFxuICAgICAgICAgICAgICAgICAgICAgICAgaXNBc2MsXG4gICAgICAgICAgICAgICAgICAgICAgICBHdWFyZHMuaXNCb29sZWFuKGwpLFxuICAgICAgICAgICAgICAgICAgICAgICAgR3VhcmRzLmlzQm9vbGVhbihyKSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGwsXG4gICAgICAgICAgICAgICAgICAgICAgICByXG4gICAgICAgICAgICAgICAgICAgIClcblxuICAgICAgICAgICAgICAgICAgICBpZiAoR3VhcmRzLmlzTnVtYmVyKGJvb2xlYW5Db21wYXJhdGlvbikpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG4gPSBib29sZWFuQ29tcGFyYXRpb25cbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBuXG4gICAgICAgICAgICAgICAgfSlcblxuICAgICAgICAgICAgICAgIG9uVXBkYXRlQ2FsbGJhY2soKVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgaW5zdGFsbCgpXG5cbiAgICAgICAgaWYgKCFjYWxsZWQpIHtcbiAgICAgICAgICAgIHVwZGF0ZSh7XG4gICAgICAgICAgICAgICAgZmllbGQsXG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgY2FsbGVkID0gdHJ1ZVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIGNsZWFudXA6IGluc3RhbGwsXG4gICAgICAgICAgICB1cGRhdGUsXG4gICAgICAgIH1cbiAgICB9XG5cbmV4cG9ydCBkZWZhdWx0IGNyZWF0ZVNvcnRcbiJdfQ==
