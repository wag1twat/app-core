"use strict";var __importDefault=function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.createSort=void 0;const Types_1=require("../../Types"),Guards_1=require("../../../Guards"),get_xpath_1=__importDefault(require("../../Object/get-xpath")),get_compare_function_1=__importDefault(require("./get-compare-function")),createSort=f=>e=>{let t=!1;const{field:r,order:d,orders:_,onUpdate:s}=e,a={_collection:[...f],_order:d||Types_1.Types.Array.Sort.defaultOrder,_orders:_||Types_1.Types.Array.Sort.defaultOrders,_field:r||void 0},i=()=>{Guards_1.Guards.isFunc(s)&&s(a)},o=e=>Guards_1.Guards.isString(a._field)?e[a._field]:Guards_1.Guards.isObject(a._field)?a._field.handler((0,get_xpath_1.default)(e)(a._field.xpath)):e;const u=e=>{Guards_1.Guards.isUndefined(e)||(a._field=e)},l=(e,r)=>{let d=!1;r?Guards_1.Guards.isString(a._field)&&Guards_1.Guards.isString(e)?a._field===e&&(d=t):Guards_1.Guards.isString(a._field)&&Guards_1.Guards.isObject(e)?a._field===e.xpath&&(d=t):Guards_1.Guards.isObject(a._field)&&Guards_1.Guards.isString(e)?a._field.xpath===e&&(d=t):Guards_1.Guards.isObject(a._field)&&Guards_1.Guards.isObject(e)&&a._field.xpath===e.xpath&&(d=t):d=t,d&&(r=a._orders.length-1,e=a._orders.indexOf(a._order)+1,a._order=e<=r?a._orders[e]:a._orders[0])};e=(e={})=>{var{field:e,noUpdateOrderFalsyEqualXPath:r=!1}=e;l(e,r),u(e),"default"===a._order?a._collection=[...f]:a._collection=a._collection.sort((e,r)=>(0,get_compare_function_1.default)(a._order,o(e),o(r))),i()};return t||(e({field:r}),t=!0),{cleanup:()=>{a._field=r||void 0,a._order=d||Types_1.Types.Array.Sort.defaultOrder,a._orders=_||Types_1.Types.Array.Sort.defaultOrders,a._collection=[...f],i()},update:e}};exports.createSort=createSort;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkJhc2UvQXJyYXkvY3JlYXRlLXNvcnQvY3JlYXRlLXNvcnQuanMiLCIuLi9zcmMvQmFzZS9BcnJheS9jcmVhdGUtc29ydC9jcmVhdGUtc29ydC50cyJdLCJuYW1lcyI6WyJfX2ltcG9ydERlZmF1bHQiLCJtb2QiLCJfX2VzTW9kdWxlIiwiT2JqZWN0IiwiZGVmaW5lUHJvcGVydHkiLCJleHBvcnRzIiwiY3JlYXRlU29ydCIsIlR5cGVzXzEiLCJyZXF1aXJlIiwiR3VhcmRzXzEiLCJnZXRfeHBhdGhfMSIsImdldF9jb21wYXJlX2Z1bmN0aW9uXzEiLCJjb2xsZWN0aW9uIiwib3B0aW9ucyIsImxldCIsImNhbGxlZCIsImZpZWxkIiwib3JkZXIiLCJvcmRlcnMiLCJvblVwZGF0ZSIsInN0YXRlIiwiX2NvbGxlY3Rpb24iLCJfb3JkZXIiLCJUeXBlcyIsIkFycmF5IiwiU29ydCIsImRlZmF1bHRPcmRlciIsIl9vcmRlcnMiLCJkZWZhdWx0T3JkZXJzIiwiX2ZpZWxkIiwidW5kZWZpbmVkIiwib25VcGRhdGVDYWxsYmFjayIsIkd1YXJkcyIsImlzRnVuYyIsImdldFZhbHVlIiwiaXRlbSIsImlzU3RyaW5nIiwiaXNPYmplY3QiLCJoYW5kbGVyIiwiZGVmYXVsdCIsInhwYXRoIiwic2V0RmllbGQiLCJpc1VuZGVmaW5lZCIsInNldE9yZGVyIiwibm9VcGRhdGVPcmRlckZhbHN5RXF1YWxYUGF0aCIsImlzIiwibGFzdE9yZGVySW5kZXgiLCJsZW5ndGgiLCJuZXh0T3JkZXJJbmRleCIsImluZGV4T2YiLCJ1cGRhdGUiLCJzb3J0IiwibCIsInIiLCJjbGVhbnVwIl0sIm1hcHBpbmdzIjoiQUFBQSxhQUNBLElBQUlBLGdCQUFvRCxTQUFVQyxHQUE5REQsT0FBQUEsR0FBZUMsRUFBSUMsV0FBUUQsRUFBS0QsQ0FBQUEsUUFBZUMsQ0FBSyxDQUV4RCxFQUNBRSxPQUY2Q0MsZUFBV0gsUUFBQUEsYUFBQUEsQ0FBQUEsTUFBQUEsQ0FBQUEsQ0FBQUEsQ0FBQUEsRUFHeERJ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RCxFQUFTLENBQUEsR0FHTixDQUNIdUMsUUF2RllBLEtBQ1psQyxFQUFNUyxPQUFTYixHQUFnQmMsS0FBQUEsRUFDL0JWLEVBQU1FLE9BQVNMLEdBQWdCVixRQUFBZ0IsTUFBTUMsTUFBTUMsS0FBS0MsYUFDaEROLEVBQU1PLFFBQVVULEdBQWtCWCxRQUFBZ0IsTUFBTUMsTUFBTUMsS0FBS0csY0FDbkRSLEVBQU1DLFlBQWMsQ0FBQyxHQUFHVCxHQUN4Qm1CLEVBQWdCLENBQ3BCLEVBa0ZJbUIsT0FBQUEsQ0FMQW5DLENBT1IsRUFFS1YsUUFBQUMsV0FBQUEiLCJmaWxlIjoiQmFzZS9BcnJheS9jcmVhdGUtc29ydC9jcmVhdGUtc29ydC5qcyIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xudmFyIF9faW1wb3J0RGVmYXVsdCA9ICh0aGlzICYmIHRoaXMuX19pbXBvcnREZWZhdWx0KSB8fCBmdW5jdGlvbiAobW9kKSB7XG4gICAgcmV0dXJuIChtb2QgJiYgbW9kLl9fZXNNb2R1bGUpID8gbW9kIDogeyBcImRlZmF1bHRcIjogbW9kIH07XG59O1xuT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFwiX19lc01vZHVsZVwiLCB7IHZhbHVlOiB0cnVlIH0pO1xuZXhwb3J0cy5jcmVhdGVTb3J0ID0gdm9pZCAwO1xuY29uc3QgVHlwZXNfMSA9IHJlcXVpcmUoXCIuLi8uLi9UeXBlc1wiKTtcbmNvbnN0IEd1YXJkc18xID0gcmVxdWlyZShcIi4uLy4uLy4uL0d1YXJkc1wiKTtcbmNvbnN0IGdldF94cGF0aF8xID0gX19pbXBvcnREZWZhdWx0KHJlcXVpcmUoXCIuLi8uLi9PYmplY3QvZ2V0LXhwYXRoXCIpKTtcbmNvbnN0IGdldF9jb21wYXJlX2Z1bmN0aW9uXzEgPSBfX2ltcG9ydERlZmF1bHQocmVxdWlyZShcIi4vZ2V0LWNvbXBhcmUtZnVuY3Rpb25cIikpO1xuY29uc3QgY3JlYXRlU29ydCA9IChjb2xsZWN0aW9uKSA9PiAob3B0aW9ucykgPT4ge1xuICAgIGxldCBjYWxsZWQgPSBmYWxzZTtcbiAgICBjb25zdCB7IGZpZWxkLCBvcmRlciwgb3JkZXJzLCBvblVwZGF0ZSB9ID0gb3B0aW9ucztcbiAgICBjb25zdCBzdGF0ZSA9IHtcbiAgICAgICAgX2NvbGxlY3Rpb246IFsuLi5jb2xsZWN0aW9uXSxcbiAgICAgICAgX29yZGVyOiBvcmRlciA/IG9yZGVyIDogVHlwZXNfMS5UeXBlcy5BcnJheS5Tb3J0LmRlZmF1bHRPcmRlcixcbiAgICAgICAgX29yZGVyczogb3JkZXJzID8gb3JkZXJzIDogVHlwZXNfMS5UeXBlcy5BcnJheS5Tb3J0LmRlZmF1bHRPcmRlcnMsXG4gICAgICAgIF9maWVsZDogZmllbGQgPyBmaWVsZCA6IHVuZGVmaW5lZCxcbiAgICB9O1xuICAgIC8vY2FsbGJhY2tzXG4gICAgY29uc3Qgb25VcGRhdGVDYWxsYmFjayA9ICgpID0+IHtcbiAgICAgICAgaWYgKEd1YXJkc18xLkd1YXJkcy5pc0Z1bmMob25VcGRhdGUpKSB7XG4gICAgICAgICAgICBvblVwZGF0ZShzdGF0ZSk7XG4gICAgICAgIH1cbiAgICB9O1xuICAgIC8vIHV0aWxpdGllc1xuICAgIGNvbnN0IGdldFZhbHVlID0gKGl0ZW0pID0+IHtcbiAgICAgICAgaWYgKEd1YXJkc18xLkd1YXJkcy5pc1N0cmluZyhzdGF0ZS5fZmllbGQpKSB7XG4gICAgICAgICAgICByZXR1cm4gaXRlbVtzdGF0ZS5fZmllbGRdO1xuICAgICAgICB9XG4gICAgICAgIGlmIChHdWFyZHNfMS5HdWFyZHMuaXNPYmplY3Qoc3RhdGUuX2ZpZWxkKSkge1xuICAgICAgICAgICAgcmV0dXJuIHN0YXRlLl9maWVsZC5oYW5kbGVyKCgwLCBnZXRfeHBhdGhfMS5kZWZhdWx0KShpdGVtKShzdGF0ZS5fZmllbGQueHBhdGgpKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gaXRlbTtcbiAgICB9O1xuICAgIGNvbnN0IGNsZWFudXAgPSAoKSA9PiB7XG4gICAgICAgIHN0YXRlLl9maWVsZCA9IGZpZWxkID8gZmllbGQgOiB1bmRlZmluZWQ7XG4gICAgICAgIHN0YXRlLl9vcmRlciA9IG9yZGVyID8gb3JkZXIgOiBUeXBlc18xLlR5cGVzLkFycmF5LlNvcnQuZGVmYXVsdE9yZGVyO1xuICAgICAgICBzdGF0ZS5fb3JkZXJzID0gb3JkZXJzID8gb3JkZXJzIDogVHlwZXNfMS5UeXBlcy5BcnJheS5Tb3J0LmRlZmF1bHRPcmRlcnM7XG4gICAgICAgIHN0YXRlLl9jb2xsZWN0aW9uID0gWy4uLmNvbGxlY3Rpb25dO1xuICAgICAgICBvblVwZGF0ZUNhbGxiYWNrKCk7XG4gICAgfTtcbiAgICBjb25zdCBzZXRGaWVsZCA9IChmaWVsZCkgPT4ge1xuICAgICAgICBpZiAoIUd1YXJkc18xLkd1YXJkcy5pc1VuZGVmaW5lZChmaWVsZCkpIHtcbiAgICAgICAgICAgIHN0YXRlLl9maWVsZCA9IGZpZWxkO1xuICAgICAgICB9XG4gICAgfTtcbiAgICBjb25zdCBzZXRPcmRlciA9IChmaWVsZCwgbm9VcGRhdGVPcmRlckZhbHN5RXF1YWxYUGF0aCkgPT4ge1xuICAgICAgICBsZXQgaXMgPSBmYWxzZTtcbiAgICAgICAgaWYgKG5vVXBkYXRlT3JkZXJGYWxzeUVxdWFsWFBhdGgpIHtcbiAgICAgICAgICAgIGlmIChHdWFyZHNfMS5HdWFyZHMuaXNTdHJpbmcoc3RhdGUuX2ZpZWxkKSAmJiBHdWFyZHNfMS5HdWFyZHMuaXNTdHJpbmcoZmllbGQpKSB7XG4gICAgICAgICAgICAgICAgaWYgKHN0YXRlLl9maWVsZCA9PT0gZmllbGQpIHtcbiAgICAgICAgICAgICAgICAgICAgaXMgPSB0cnVlICYmIGNhbGxlZDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIGlmIChHdWFyZHNfMS5HdWFyZHMuaXNTdHJpbmcoc3RhdGUuX2ZpZWxkKSAmJiBHdWFyZHNfMS5HdWFyZHMuaXNPYmplY3QoZmllbGQpKSB7XG4gICAgICAgICAgICAgICAgaWYgKHN0YXRlLl9maWVsZCA9PT0gZmllbGQueHBhdGgpIHtcbiAgICAgICAgICAgICAgICAgICAgaXMgPSB0cnVlICYmIGNhbGxlZDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIGlmIChHdWFyZHNfMS5HdWFyZHMuaXNPYmplY3Qoc3RhdGUuX2ZpZWxkKSAmJiBHdWFyZHNfMS5HdWFyZHMuaXNTdHJpbmcoZmllbGQpKSB7XG4gICAgICAgICAgICAgICAgaWYgKHN0YXRlLl9maWVsZC54cGF0aCA9PT0gZmllbGQpIHtcbiAgICAgICAgICAgICAgICAgICAgaXMgPSB0cnVlICYmIGNhbGxlZDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIGlmIChHdWFyZHNfMS5HdWFyZHMuaXNPYmplY3Qoc3RhdGUuX2ZpZWxkKSAmJiBHdWFyZHNfMS5HdWFyZHMuaXNPYmplY3QoZmllbGQpKSB7XG4gICAgICAgICAgICAgICAgaWYgKHN0YXRlLl9maWVsZC54cGF0aCA9PT0gZmllbGQueHBhdGgpIHtcbiAgICAgICAgICAgICAgICAgICAgaXMgPSB0cnVlICYmIGNhbGxlZDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICBpcyA9IHRydWUgJiYgY2FsbGVkO1xuICAgICAgICB9XG4gICAgICAgIGlmIChpcykge1xuICAgICAgICAgICAgY29uc3QgbGFzdE9yZGVySW5kZXggPSBzdGF0ZS5fb3JkZXJzLmxlbmd0aCAtIDE7XG4gICAgICAgICAgICBjb25zdCBjdXJyZW50T3JkZXJJbmRleCA9IHN0YXRlLl9vcmRlcnMuaW5kZXhPZihzdGF0ZS5fb3JkZXIpO1xuICAgICAgICAgICAgY29uc3QgbmV4dE9yZGVySW5kZXggPSBjdXJyZW50T3JkZXJJbmRleCArIDE7XG4gICAgICAgICAgICBzdGF0ZS5fb3JkZXIgPVxuICAgICAgICAgICAgICAgIG5leHRPcmRlckluZGV4IDw9IGxhc3RPcmRlckluZGV4XG4gICAgICAgICAgICAgICAgICAgID8gc3RhdGUuX29yZGVyc1tuZXh0T3JkZXJJbmRleF1cbiAgICAgICAgICAgICAgICAgICAgOiBzdGF0ZS5fb3JkZXJzWzBdO1xuICAgICAgICB9XG4gICAgfTtcbiAgICBjb25zdCB1cGRhdGUgPSAob3B0aW9ucyA9IHt9KSA9PiB7XG4gICAgICAgIGNvbnN0IHsgZmllbGQsIG5vVXBkYXRlT3JkZXJGYWxzeUVxdWFsWFBhdGggPSBmYWxzZSB9ID0gb3B0aW9ucztcbiAgICAgICAgc2V0T3JkZXIoZmllbGQsIG5vVXBkYXRlT3JkZXJGYWxzeUVxdWFsWFBhdGgpO1xuICAgICAgICBzZXRGaWVsZChmaWVsZCk7XG4gICAgICAgIGlmIChzdGF0ZS5fb3JkZXIgPT09ICdkZWZhdWx0Jykge1xuICAgICAgICAgICAgc3RhdGUuX2NvbGxlY3Rpb24gPSBbLi4uY29sbGVjdGlvbl07XG4gICAgICAgICAgICBvblVwZGF0ZUNhbGxiYWNrKCk7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICBzdGF0ZS5fY29sbGVjdGlvbiA9IHN0YXRlLl9jb2xsZWN0aW9uLnNvcnQoKGwsIHIpID0+ICgwLCBnZXRfY29tcGFyZV9mdW5jdGlvbl8xLmRlZmF1bHQpKHN0YXRlLl9vcmRlciwgZ2V0VmFsdWUobCksIGdldFZhbHVlKHIpKSk7XG4gICAgICAgICAgICBvblVwZGF0ZUNhbGxiYWNrKCk7XG4gICAgICAgIH1cbiAgICB9O1xuICAgIGlmICghY2FsbGVkKSB7XG4gICAgICAgIHVwZGF0ZSh7XG4gICAgICAgICAgICBmaWVsZCxcbiAgICAgICAgfSk7XG4gICAgICAgIGNhbGxlZCA9IHRydWU7XG4gICAgfVxuICAgIHJldHVybiB7XG4gICAgICAgIGNsZWFudXAsXG4gICAgICAgIHVwZGF0ZSxcbiAgICB9O1xufTtcbmV4cG9ydHMuY3JlYXRlU29ydCA9IGNyZWF0ZVNvcnQ7XG4iLCJpbXBvcnQgeyBUeXBlcyB9IGZyb20gJy4uLy4uL1R5cGVzJ1xuaW1wb3J0IHsgR3VhcmRzIH0gZnJvbSAnLi4vLi4vLi4vR3VhcmRzJ1xuaW1wb3J0IGdldFhQYXRoIGZyb20gJy4uLy4uL09iamVjdC9nZXQteHBhdGgnXG5pbXBvcnQgZ2V0Q29tcGFyZUZ1bmN0aW9uIGZyb20gJy4vZ2V0LWNvbXBhcmUtZnVuY3Rpb24nXG5cbmNvbnN0IGNyZWF0ZVNvcnQgPVxuICAgIDxUIGV4dGVuZHMgYW55W10+KGNvbGxlY3Rpb246IFQpID0+XG4gICAgPFhQYXRoIGV4dGVuZHMgVHlwZXMuVXRpbGl0eS5KU09OUGF0aDxUeXBlcy5BcnJheS5PZjxUPj4+KFxuICAgICAgICBvcHRpb25zOiBUeXBlcy5BcnJheS5Tb3J0Lk9wdGlvbnM8VCwgWFBhdGg+XG4gICAgKSA9PiB7XG4gICAgICAgIGxldCBjYWxsZWQ6IGJvb2xlYW4gPSBmYWxzZVxuXG4gICAgICAgIGNvbnN0IHsgZmllbGQsIG9yZGVyLCBvcmRlcnMsIG9uVXBkYXRlIH0gPSBvcHRpb25zXG5cbiAgICAgICAgY29uc3Qgc3RhdGU6IFR5cGVzLkFycmF5LlNvcnQuU3RhdGU8VD4gPSB7XG4gICAgICAgICAgICBfY29sbGVjdGlvbjogWy4uLmNvbGxlY3Rpb25dIGFzIFQsXG4gICAgICAgICAgICBfb3JkZXI6IG9yZGVyID8gb3JkZXIgOiBUeXBlcy5BcnJheS5Tb3J0LmRlZmF1bHRPcmRlcixcbiAgICAgICAgICAgIF9vcmRlcnM6IG9yZGVycyA/IG9yZGVycyA6IFR5cGVzLkFycmF5LlNvcnQuZGVmYXVsdE9yZGVycyxcbiAgICAgICAgICAgIF9maWVsZDogZmllbGQgPyBmaWVsZCA6IHVuZGVmaW5lZCxcbiAgICAgICAgfVxuXG4gICAgICAgIC8vY2FsbGJhY2tzXG4gICAgICAgIGNvbnN0IG9uVXBkYXRlQ2FsbGJhY2sgPSAoKSA9PiB7XG4gICAgICAgICAgICBpZiAoR3VhcmRzLmlzRnVuYyhvblVwZGF0ZSkpIHtcbiAgICAgICAgICAgICAgICBvblVwZGF0ZShzdGF0ZSlcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICAvLyB1dGlsaXRpZXNcbiAgICAgICAgY29uc3QgZ2V0VmFsdWUgPSAoaXRlbTogVHlwZXMuQXJyYXkuT2Y8VD4pID0+IHtcbiAgICAgICAgICAgIGlmIChHdWFyZHMuaXNTdHJpbmcoc3RhdGUuX2ZpZWxkKSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBpdGVtW3N0YXRlLl9maWVsZF1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChHdWFyZHMuaXNPYmplY3Qoc3RhdGUuX2ZpZWxkKSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBzdGF0ZS5fZmllbGQuaGFuZGxlcihnZXRYUGF0aChpdGVtKShzdGF0ZS5fZmllbGQueHBhdGgpKVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIGl0ZW1cbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGNsZWFudXAgPSAoKSA9PiB7XG4gICAgICAgICAgICBzdGF0ZS5fZmllbGQgPSBmaWVsZCA/IGZpZWxkIDogdW5kZWZpbmVkXG4gICAgICAgICAgICBzdGF0ZS5fb3JkZXIgPSBvcmRlciA/IG9yZGVyIDogVHlwZXMuQXJyYXkuU29ydC5kZWZhdWx0T3JkZXJcbiAgICAgICAgICAgIHN0YXRlLl9vcmRlcnMgPSBvcmRlcnMgPyBvcmRlcnMgOiBUeXBlcy5BcnJheS5Tb3J0LmRlZmF1bHRPcmRlcnNcbiAgICAgICAgICAgIHN0YXRlLl9jb2xsZWN0aW9uID0gWy4uLmNvbGxlY3Rpb25dIGFzIFRcbiAgICAgICAgICAgIG9uVXBkYXRlQ2FsbGJhY2soKVxuICAgICAgICB9XG5cbiAgICAgICAgY29uc3Qgc2V0RmllbGQgPSA8WFBhdGggZXh0ZW5kcyBUeXBlcy5VdGlsaXR5LkpTT05QYXRoPFR5cGVzLkFycmF5Lk9mPFQ+Pj4oXG4gICAgICAgICAgICBmaWVsZDogVHlwZXMuQXJyYXkuU29ydC5GaWVsZDxULCBYUGF0aD4gfCB1bmRlZmluZWRcbiAgICAgICAgKSA9PiB7XG4gICAgICAgICAgICBpZiAoIUd1YXJkcy5pc1VuZGVmaW5lZChmaWVsZCkpIHtcbiAgICAgICAgICAgICAgICBzdGF0ZS5fZmllbGQgPSBmaWVsZFxuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgY29uc3Qgc2V0T3JkZXIgPSA8WFBhdGggZXh0ZW5kcyBUeXBlcy5VdGlsaXR5LkpTT05QYXRoPFR5cGVzLkFycmF5Lk9mPFQ+Pj4oXG4gICAgICAgICAgICBmaWVsZDogVHlwZXMuQXJyYXkuU29ydC5GaWVsZDxULCBYUGF0aD4gfCB1bmRlZmluZWQsXG4gICAgICAgICAgICBub1VwZGF0ZU9yZGVyRmFsc3lFcXVhbFhQYXRoOiBib29sZWFuXG4gICAgICAgICkgPT4ge1xuICAgICAgICAgICAgbGV0IGlzOiBib29sZWFuID0gZmFsc2VcblxuICAgICAgICAgICAgaWYgKG5vVXBkYXRlT3JkZXJGYWxzeUVxdWFsWFBhdGgpIHtcbiAgICAgICAgICAgICAgICBpZiAoR3VhcmRzLmlzU3RyaW5nKHN0YXRlLl9maWVsZCkgJiYgR3VhcmRzLmlzU3RyaW5nKGZpZWxkKSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoc3RhdGUuX2ZpZWxkID09PSBmaWVsZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaXMgPSB0cnVlICYmIGNhbGxlZFxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChHdWFyZHMuaXNTdHJpbmcoc3RhdGUuX2ZpZWxkKSAmJiBHdWFyZHMuaXNPYmplY3QoZmllbGQpKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5fZmllbGQgPT09IGZpZWxkLnhwYXRoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpcyA9IHRydWUgJiYgY2FsbGVkXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKEd1YXJkcy5pc09iamVjdChzdGF0ZS5fZmllbGQpICYmIEd1YXJkcy5pc1N0cmluZyhmaWVsZCkpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLl9maWVsZC54cGF0aCA9PT0gZmllbGQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlzID0gdHJ1ZSAmJiBjYWxsZWRcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoR3VhcmRzLmlzT2JqZWN0KHN0YXRlLl9maWVsZCkgJiYgR3VhcmRzLmlzT2JqZWN0KGZpZWxkKSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoc3RhdGUuX2ZpZWxkLnhwYXRoID09PSBmaWVsZC54cGF0aCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaXMgPSB0cnVlICYmIGNhbGxlZFxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBpcyA9IHRydWUgJiYgY2FsbGVkXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChpcykge1xuICAgICAgICAgICAgICAgIGNvbnN0IGxhc3RPcmRlckluZGV4ID0gc3RhdGUuX29yZGVycy5sZW5ndGggLSAxXG4gICAgICAgICAgICAgICAgY29uc3QgY3VycmVudE9yZGVySW5kZXggPSBzdGF0ZS5fb3JkZXJzLmluZGV4T2Yoc3RhdGUuX29yZGVyKVxuICAgICAgICAgICAgICAgIGNvbnN0IG5leHRPcmRlckluZGV4ID0gY3VycmVudE9yZGVySW5kZXggKyAxXG4gICAgICAgICAgICAgICAgc3RhdGUuX29yZGVyID1cbiAgICAgICAgICAgICAgICAgICAgbmV4dE9yZGVySW5kZXggPD0gbGFzdE9yZGVySW5kZXhcbiAgICAgICAgICAgICAgICAgICAgICAgID8gc3RhdGUuX29yZGVyc1tuZXh0T3JkZXJJbmRleF1cbiAgICAgICAgICAgICAgICAgICAgICAgIDogc3RhdGUuX29yZGVyc1swXVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgdXBkYXRlID0gPFhQYXRoIGV4dGVuZHMgVHlwZXMuVXRpbGl0eS5KU09OUGF0aDxUeXBlcy5BcnJheS5PZjxUPj4+KFxuICAgICAgICAgICAgb3B0aW9uczogVHlwZXMuQXJyYXkuU29ydC5VcGRhdGVPcHRpb25zPFQsIFhQYXRoPiA9IHt9XG4gICAgICAgICkgPT4ge1xuICAgICAgICAgICAgY29uc3QgeyBmaWVsZCwgbm9VcGRhdGVPcmRlckZhbHN5RXF1YWxYUGF0aCA9IGZhbHNlIH0gPSBvcHRpb25zXG5cbiAgICAgICAgICAgIHNldE9yZGVyKGZpZWxkLCBub1VwZGF0ZU9yZGVyRmFsc3lFcXVhbFhQYXRoKVxuXG4gICAgICAgICAgICBzZXRGaWVsZChmaWVsZClcblxuICAgICAgICAgICAgaWYgKHN0YXRlLl9vcmRlciA9PT0gJ2RlZmF1bHQnKSB7XG4gICAgICAgICAgICAgICAgc3RhdGUuX2NvbGxlY3Rpb24gPSBbLi4uY29sbGVjdGlvbl0gYXMgVFxuICAgICAgICAgICAgICAgIG9uVXBkYXRlQ2FsbGJhY2soKVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBzdGF0ZS5fY29sbGVjdGlvbiA9IHN0YXRlLl9jb2xsZWN0aW9uLnNvcnQoKGwsIHIpID0+XG4gICAgICAgICAgICAgICAgICAgIGdldENvbXBhcmVGdW5jdGlvbihcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLl9vcmRlciBhcyBFeGNsdWRlPFR5cGVzLkFycmF5LlNvcnQuT3JkZXIsICdkZWZhdWx0Jz4sXG4gICAgICAgICAgICAgICAgICAgICAgICBnZXRWYWx1ZShsKSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGdldFZhbHVlKHIpXG4gICAgICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgb25VcGRhdGVDYWxsYmFjaygpXG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIWNhbGxlZCkge1xuICAgICAgICAgICAgdXBkYXRlKHtcbiAgICAgICAgICAgICAgICBmaWVsZCxcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICBjYWxsZWQgPSB0cnVlXG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgY2xlYW51cCxcbiAgICAgICAgICAgIHVwZGF0ZSxcbiAgICAgICAgfVxuICAgIH1cblxuZXhwb3J0IHsgY3JlYXRlU29ydCB9XG4iXX0=
