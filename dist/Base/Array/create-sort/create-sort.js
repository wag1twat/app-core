"use strict";var __importDefault=function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.createSort=void 0;const Types_1=require("../../Types"),Guards_1=require("../../../Guards"),get_xpath_1=__importDefault(require("../../Object/get-xpath")),get_compare_function_1=__importDefault(require("./get-compare-function")),createSort=f=>e=>{let t=!1;const{field:r,order:d,orders:_,onUpdate:a}=e,s={_collection:[...f],_order:d||Types_1.Types.Array.Sort.defaultOrder,_orders:_||Types_1.Types.Array.Sort.defaultOrders,_field:r||void 0},i=()=>{Guards_1.Guards.isFunc(a)&&a(s)},o=e=>Guards_1.Guards.isString(s._field)?(0,get_xpath_1.default)(e)(s._field):Guards_1.Guards.isObject(s._field)?s._field.handler((0,get_xpath_1.default)(e)(s._field.xpath)):e;const u=e=>{Guards_1.Guards.isUndefined(e)||(s._field=e)},l=(e,r)=>{let d=!1;r?Guards_1.Guards.isString(s._field)&&Guards_1.Guards.isString(e)?s._field===e&&(d=t):Guards_1.Guards.isString(s._field)&&Guards_1.Guards.isObject(e)?s._field===e.xpath&&(d=t):Guards_1.Guards.isObject(s._field)&&Guards_1.Guards.isString(e)?s._field.xpath===e&&(d=t):Guards_1.Guards.isObject(s._field)&&Guards_1.Guards.isObject(e)&&s._field.xpath===e.xpath&&(d=t):d=t,d&&(r=s._orders.length-1,e=s._orders.indexOf(s._order)+1,s._order=e<=r?s._orders[e]:s._orders[0])};e=(e={})=>{var{field:e,noUpdateOrderFalsyEqualXPath:r=!1}=e;l(e,r),u(e),"default"===s._order?s._collection=[...f]:s._collection=s._collection.sort((e,r)=>(0,get_compare_function_1.default)(s._order,o(e),o(r))),i()};return t||(e({field:r}),t=!0),{cleanup:()=>{s._field=r||void 0,s._order=d||Types_1.Types.Array.Sort.defaultOrder,s._orders=_||Types_1.Types.Array.Sort.defaultOrders,s._collection=[...f],i()},update:e}};exports.createSort=createSort;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkJhc2UvQXJyYXkvY3JlYXRlLXNvcnQvY3JlYXRlLXNvcnQuanMiLCIuLi9zcmMvQmFzZS9BcnJheS9jcmVhdGUtc29ydC9jcmVhdGUtc29ydC50cyJdLCJuYW1lcyI6WyJfX2ltcG9ydERlZmF1bHQiLCJtb2QiLCJfX2VzTW9kdWxlIiwiT2JqZWN0IiwiZGVmaW5lUHJvcGVydHkiLCJleHBvcnRzIiwiY3JlYXRlU29ydCIsIlR5cGVzXzEiLCJyZXF1aXJlIiwiR3VhcmRzXzEiLCJnZXRfeHBhdGhfMSIsImdldF9jb21wYXJlX2Z1bmN0aW9uXzEiLCJjb2xsZWN0aW9uIiwib3B0aW9ucyIsImxldCIsImNhbGxlZCIsImZpZWxkIiwib3JkZXIiLCJvcmRlcnMiLCJvblVwZGF0ZSIsInN0YXRlIiwiX2NvbGxlY3Rpb24iLCJfb3JkZXIiLCJUeXBlcyIsIkFycmF5IiwiU29ydCIsImRlZmF1bHRPcmRlciIsIl9vcmRlcnMiLCJkZWZhdWx0T3JkZXJzIiwiX2ZpZWxkIiwidW5kZWZpbmVkIiwib25VcGRhdGVDYWxsYmFjayIsIkd1YXJkcyIsImlzRnVuYyIsImdldFZhbHVlIiwiaXRlbSIsImlzU3RyaW5nIiwiZGVmYXVsdCIsImlzT2JqZWN0IiwiaGFuZGxlciIsInhwYXRoIiwic2V0RmllbGQiLCJpc1VuZGVmaW5lZCIsInNldE9yZGVyIiwibm9VcGRhdGVPcmRlckZhbHN5RXF1YWxYUGF0aCIsImlzIiwibGFzdE9yZGVySW5kZXgiLCJsZW5ndGgiLCJuZXh0T3JkZXJJbmRleCIsImluZGV4T2YiLCJ1cGRhdGUiLCJzb3J0IiwibCIsInIiLCJjbGVhbnVwIl0sIm1hcHBpbmdzIjoiQUFBQSxhQUNBLElBQUlBLGdCQUFvRCxTQUFVQyxHQUE5REQsT0FBQUEsR0FBZUMsRUFBSUMsV0FBUUQsRUFBS0QsQ0FBQUEsUUFBZUMsQ0FBSyxDQUV4RCxFQUNBRSxPQUY2Q0MsZUFBV0gsUUFBQUEsYUFBQUEsQ0FBQUEsTUFBQUEsQ0FBQUEsQ0FBQUEsQ0FBQUEsRUFHeERJ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Q0FDSGxDLE1BQUFBLENEeEJSLENDeUJLLEVBQ0RELEVBQVMsQ0FBQSxHQUdOLENBQ0h1QyxRQXZGWUEsS0FDWmxDLEVBQU1TLE9BQVNiLEdBQWdCYyxLQUFBQSxFQUMvQlYsRUFBTUUsT0FBU0wsR0FBZ0JWLFFBQUFnQixNQUFNQyxNQUFNQyxLQUFLQyxhQUNoRE4sRUFBTU8sUUFBVVQsR0FBa0JYLFFBQUFnQixNQUFNQyxNQUFNQyxLQUFLRyxjQUNuRFIsRUFBTUMsWUFBYyxDQUFDLEdBQUdULEdBQ3hCbUIsRUFBZ0IsQ0FDcEIsRUFrRkltQixPQUFBQSxDQUxBbkMsQ0FPUixFQUVLVixRQUFBQyxXQUFBQSIsImZpbGUiOiJCYXNlL0FycmF5L2NyZWF0ZS1zb3J0L2NyZWF0ZS1zb3J0LmpzIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG52YXIgX19pbXBvcnREZWZhdWx0ID0gKHRoaXMgJiYgdGhpcy5fX2ltcG9ydERlZmF1bHQpIHx8IGZ1bmN0aW9uIChtb2QpIHtcbiAgICByZXR1cm4gKG1vZCAmJiBtb2QuX19lc01vZHVsZSkgPyBtb2QgOiB7IFwiZGVmYXVsdFwiOiBtb2QgfTtcbn07XG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgXCJfX2VzTW9kdWxlXCIsIHsgdmFsdWU6IHRydWUgfSk7XG5leHBvcnRzLmNyZWF0ZVNvcnQgPSB2b2lkIDA7XG5jb25zdCBUeXBlc18xID0gcmVxdWlyZShcIi4uLy4uL1R5cGVzXCIpO1xuY29uc3QgR3VhcmRzXzEgPSByZXF1aXJlKFwiLi4vLi4vLi4vR3VhcmRzXCIpO1xuY29uc3QgZ2V0X3hwYXRoXzEgPSBfX2ltcG9ydERlZmF1bHQocmVxdWlyZShcIi4uLy4uL09iamVjdC9nZXQteHBhdGhcIikpO1xuY29uc3QgZ2V0X2NvbXBhcmVfZnVuY3Rpb25fMSA9IF9faW1wb3J0RGVmYXVsdChyZXF1aXJlKFwiLi9nZXQtY29tcGFyZS1mdW5jdGlvblwiKSk7XG5jb25zdCBjcmVhdGVTb3J0ID0gKGNvbGxlY3Rpb24pID0+IChvcHRpb25zKSA9PiB7XG4gICAgbGV0IGNhbGxlZCA9IGZhbHNlO1xuICAgIGNvbnN0IHsgZmllbGQsIG9yZGVyLCBvcmRlcnMsIG9uVXBkYXRlIH0gPSBvcHRpb25zO1xuICAgIGNvbnN0IHN0YXRlID0ge1xuICAgICAgICBfY29sbGVjdGlvbjogWy4uLmNvbGxlY3Rpb25dLFxuICAgICAgICBfb3JkZXI6IG9yZGVyID8gb3JkZXIgOiBUeXBlc18xLlR5cGVzLkFycmF5LlNvcnQuZGVmYXVsdE9yZGVyLFxuICAgICAgICBfb3JkZXJzOiBvcmRlcnMgPyBvcmRlcnMgOiBUeXBlc18xLlR5cGVzLkFycmF5LlNvcnQuZGVmYXVsdE9yZGVycyxcbiAgICAgICAgX2ZpZWxkOiBmaWVsZCA/IGZpZWxkIDogdW5kZWZpbmVkLFxuICAgIH07XG4gICAgLy9jYWxsYmFja3NcbiAgICBjb25zdCBvblVwZGF0ZUNhbGxiYWNrID0gKCkgPT4ge1xuICAgICAgICBpZiAoR3VhcmRzXzEuR3VhcmRzLmlzRnVuYyhvblVwZGF0ZSkpIHtcbiAgICAgICAgICAgIG9uVXBkYXRlKHN0YXRlKTtcbiAgICAgICAgfVxuICAgIH07XG4gICAgLy8gdXRpbGl0aWVzXG4gICAgY29uc3QgZ2V0VmFsdWUgPSAoaXRlbSkgPT4ge1xuICAgICAgICBpZiAoR3VhcmRzXzEuR3VhcmRzLmlzU3RyaW5nKHN0YXRlLl9maWVsZCkpIHtcbiAgICAgICAgICAgIHJldHVybiAoMCwgZ2V0X3hwYXRoXzEuZGVmYXVsdCkoaXRlbSkoc3RhdGUuX2ZpZWxkKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoR3VhcmRzXzEuR3VhcmRzLmlzT2JqZWN0KHN0YXRlLl9maWVsZCkpIHtcbiAgICAgICAgICAgIHJldHVybiBzdGF0ZS5fZmllbGQuaGFuZGxlcigoMCwgZ2V0X3hwYXRoXzEuZGVmYXVsdCkoaXRlbSkoc3RhdGUuX2ZpZWxkLnhwYXRoKSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGl0ZW07XG4gICAgfTtcbiAgICBjb25zdCBjbGVhbnVwID0gKCkgPT4ge1xuICAgICAgICBzdGF0ZS5fZmllbGQgPSBmaWVsZCA/IGZpZWxkIDogdW5kZWZpbmVkO1xuICAgICAgICBzdGF0ZS5fb3JkZXIgPSBvcmRlciA/IG9yZGVyIDogVHlwZXNfMS5UeXBlcy5BcnJheS5Tb3J0LmRlZmF1bHRPcmRlcjtcbiAgICAgICAgc3RhdGUuX29yZGVycyA9IG9yZGVycyA/IG9yZGVycyA6IFR5cGVzXzEuVHlwZXMuQXJyYXkuU29ydC5kZWZhdWx0T3JkZXJzO1xuICAgICAgICBzdGF0ZS5fY29sbGVjdGlvbiA9IFsuLi5jb2xsZWN0aW9uXTtcbiAgICAgICAgb25VcGRhdGVDYWxsYmFjaygpO1xuICAgIH07XG4gICAgY29uc3Qgc2V0RmllbGQgPSAoZmllbGQpID0+IHtcbiAgICAgICAgaWYgKCFHdWFyZHNfMS5HdWFyZHMuaXNVbmRlZmluZWQoZmllbGQpKSB7XG4gICAgICAgICAgICBzdGF0ZS5fZmllbGQgPSBmaWVsZDtcbiAgICAgICAgfVxuICAgIH07XG4gICAgY29uc3Qgc2V0T3JkZXIgPSAoZmllbGQsIG5vVXBkYXRlT3JkZXJGYWxzeUVxdWFsWFBhdGgpID0+IHtcbiAgICAgICAgbGV0IGlzID0gZmFsc2U7XG4gICAgICAgIGlmIChub1VwZGF0ZU9yZGVyRmFsc3lFcXVhbFhQYXRoKSB7XG4gICAgICAgICAgICBpZiAoR3VhcmRzXzEuR3VhcmRzLmlzU3RyaW5nKHN0YXRlLl9maWVsZCkgJiYgR3VhcmRzXzEuR3VhcmRzLmlzU3RyaW5nKGZpZWxkKSkge1xuICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5fZmllbGQgPT09IGZpZWxkKSB7XG4gICAgICAgICAgICAgICAgICAgIGlzID0gdHJ1ZSAmJiBjYWxsZWQ7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSBpZiAoR3VhcmRzXzEuR3VhcmRzLmlzU3RyaW5nKHN0YXRlLl9maWVsZCkgJiYgR3VhcmRzXzEuR3VhcmRzLmlzT2JqZWN0KGZpZWxkKSkge1xuICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5fZmllbGQgPT09IGZpZWxkLnhwYXRoKSB7XG4gICAgICAgICAgICAgICAgICAgIGlzID0gdHJ1ZSAmJiBjYWxsZWQ7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSBpZiAoR3VhcmRzXzEuR3VhcmRzLmlzT2JqZWN0KHN0YXRlLl9maWVsZCkgJiYgR3VhcmRzXzEuR3VhcmRzLmlzU3RyaW5nKGZpZWxkKSkge1xuICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5fZmllbGQueHBhdGggPT09IGZpZWxkKSB7XG4gICAgICAgICAgICAgICAgICAgIGlzID0gdHJ1ZSAmJiBjYWxsZWQ7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSBpZiAoR3VhcmRzXzEuR3VhcmRzLmlzT2JqZWN0KHN0YXRlLl9maWVsZCkgJiYgR3VhcmRzXzEuR3VhcmRzLmlzT2JqZWN0KGZpZWxkKSkge1xuICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5fZmllbGQueHBhdGggPT09IGZpZWxkLnhwYXRoKSB7XG4gICAgICAgICAgICAgICAgICAgIGlzID0gdHJ1ZSAmJiBjYWxsZWQ7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgaXMgPSB0cnVlICYmIGNhbGxlZDtcbiAgICAgICAgfVxuICAgICAgICBpZiAoaXMpIHtcbiAgICAgICAgICAgIGNvbnN0IGxhc3RPcmRlckluZGV4ID0gc3RhdGUuX29yZGVycy5sZW5ndGggLSAxO1xuICAgICAgICAgICAgY29uc3QgY3VycmVudE9yZGVySW5kZXggPSBzdGF0ZS5fb3JkZXJzLmluZGV4T2Yoc3RhdGUuX29yZGVyKTtcbiAgICAgICAgICAgIGNvbnN0IG5leHRPcmRlckluZGV4ID0gY3VycmVudE9yZGVySW5kZXggKyAxO1xuICAgICAgICAgICAgc3RhdGUuX29yZGVyID1cbiAgICAgICAgICAgICAgICBuZXh0T3JkZXJJbmRleCA8PSBsYXN0T3JkZXJJbmRleFxuICAgICAgICAgICAgICAgICAgICA/IHN0YXRlLl9vcmRlcnNbbmV4dE9yZGVySW5kZXhdXG4gICAgICAgICAgICAgICAgICAgIDogc3RhdGUuX29yZGVyc1swXTtcbiAgICAgICAgfVxuICAgIH07XG4gICAgY29uc3QgdXBkYXRlID0gKG9wdGlvbnMgPSB7fSkgPT4ge1xuICAgICAgICBjb25zdCB7IGZpZWxkLCBub1VwZGF0ZU9yZGVyRmFsc3lFcXVhbFhQYXRoID0gZmFsc2UgfSA9IG9wdGlvbnM7XG4gICAgICAgIHNldE9yZGVyKGZpZWxkLCBub1VwZGF0ZU9yZGVyRmFsc3lFcXVhbFhQYXRoKTtcbiAgICAgICAgc2V0RmllbGQoZmllbGQpO1xuICAgICAgICBpZiAoc3RhdGUuX29yZGVyID09PSAnZGVmYXVsdCcpIHtcbiAgICAgICAgICAgIHN0YXRlLl9jb2xsZWN0aW9uID0gWy4uLmNvbGxlY3Rpb25dO1xuICAgICAgICAgICAgb25VcGRhdGVDYWxsYmFjaygpO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgc3RhdGUuX2NvbGxlY3Rpb24gPSBzdGF0ZS5fY29sbGVjdGlvbi5zb3J0KChsLCByKSA9PiAoMCwgZ2V0X2NvbXBhcmVfZnVuY3Rpb25fMS5kZWZhdWx0KShzdGF0ZS5fb3JkZXIsIGdldFZhbHVlKGwpLCBnZXRWYWx1ZShyKSkpO1xuICAgICAgICAgICAgb25VcGRhdGVDYWxsYmFjaygpO1xuICAgICAgICB9XG4gICAgfTtcbiAgICBpZiAoIWNhbGxlZCkge1xuICAgICAgICB1cGRhdGUoe1xuICAgICAgICAgICAgZmllbGQsXG4gICAgICAgIH0pO1xuICAgICAgICBjYWxsZWQgPSB0cnVlO1xuICAgIH1cbiAgICByZXR1cm4ge1xuICAgICAgICBjbGVhbnVwLFxuICAgICAgICB1cGRhdGUsXG4gICAgfTtcbn07XG5leHBvcnRzLmNyZWF0ZVNvcnQgPSBjcmVhdGVTb3J0O1xuIiwiaW1wb3J0IHsgVHlwZXMgfSBmcm9tICcuLi8uLi9UeXBlcydcbmltcG9ydCB7IEd1YXJkcyB9IGZyb20gJy4uLy4uLy4uL0d1YXJkcydcbmltcG9ydCBnZXRYUGF0aCBmcm9tICcuLi8uLi9PYmplY3QvZ2V0LXhwYXRoJ1xuaW1wb3J0IGdldENvbXBhcmVGdW5jdGlvbiBmcm9tICcuL2dldC1jb21wYXJlLWZ1bmN0aW9uJ1xuXG5jb25zdCBjcmVhdGVTb3J0ID1cbiAgICA8VCBleHRlbmRzIGFueVtdPihjb2xsZWN0aW9uOiBUKSA9PlxuICAgIDxYUGF0aCBleHRlbmRzIFR5cGVzLlV0aWxpdHkuSlNPTlBhdGg8VHlwZXMuQXJyYXkuT2Y8VD4+PihcbiAgICAgICAgb3B0aW9uczogVHlwZXMuQXJyYXkuU29ydC5PcHRpb25zPFQsIFhQYXRoPlxuICAgICkgPT4ge1xuICAgICAgICBsZXQgY2FsbGVkOiBib29sZWFuID0gZmFsc2VcblxuICAgICAgICBjb25zdCB7IGZpZWxkLCBvcmRlciwgb3JkZXJzLCBvblVwZGF0ZSB9ID0gb3B0aW9uc1xuXG4gICAgICAgIGNvbnN0IHN0YXRlOiBUeXBlcy5BcnJheS5Tb3J0LlN0YXRlPFQ+ID0ge1xuICAgICAgICAgICAgX2NvbGxlY3Rpb246IFsuLi5jb2xsZWN0aW9uXSBhcyBULFxuICAgICAgICAgICAgX29yZGVyOiBvcmRlciA/IG9yZGVyIDogVHlwZXMuQXJyYXkuU29ydC5kZWZhdWx0T3JkZXIsXG4gICAgICAgICAgICBfb3JkZXJzOiBvcmRlcnMgPyBvcmRlcnMgOiBUeXBlcy5BcnJheS5Tb3J0LmRlZmF1bHRPcmRlcnMsXG4gICAgICAgICAgICBfZmllbGQ6IGZpZWxkID8gZmllbGQgOiB1bmRlZmluZWQsXG4gICAgICAgIH1cblxuICAgICAgICAvL2NhbGxiYWNrc1xuICAgICAgICBjb25zdCBvblVwZGF0ZUNhbGxiYWNrID0gKCkgPT4ge1xuICAgICAgICAgICAgaWYgKEd1YXJkcy5pc0Z1bmMob25VcGRhdGUpKSB7XG4gICAgICAgICAgICAgICAgb25VcGRhdGUoc3RhdGUpXG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgLy8gdXRpbGl0aWVzXG4gICAgICAgIGNvbnN0IGdldFZhbHVlID0gKGl0ZW06IFR5cGVzLkFycmF5Lk9mPFQ+KSA9PiB7XG4gICAgICAgICAgICBpZiAoR3VhcmRzLmlzU3RyaW5nKHN0YXRlLl9maWVsZCkpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZ2V0WFBhdGgoaXRlbSkoc3RhdGUuX2ZpZWxkKVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKEd1YXJkcy5pc09iamVjdChzdGF0ZS5fZmllbGQpKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHN0YXRlLl9maWVsZC5oYW5kbGVyKGdldFhQYXRoKGl0ZW0pKHN0YXRlLl9maWVsZC54cGF0aCkpXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gaXRlbVxuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgY2xlYW51cCA9ICgpID0+IHtcbiAgICAgICAgICAgIHN0YXRlLl9maWVsZCA9IGZpZWxkID8gZmllbGQgOiB1bmRlZmluZWRcbiAgICAgICAgICAgIHN0YXRlLl9vcmRlciA9IG9yZGVyID8gb3JkZXIgOiBUeXBlcy5BcnJheS5Tb3J0LmRlZmF1bHRPcmRlclxuICAgICAgICAgICAgc3RhdGUuX29yZGVycyA9IG9yZGVycyA/IG9yZGVycyA6IFR5cGVzLkFycmF5LlNvcnQuZGVmYXVsdE9yZGVyc1xuICAgICAgICAgICAgc3RhdGUuX2NvbGxlY3Rpb24gPSBbLi4uY29sbGVjdGlvbl0gYXMgVFxuICAgICAgICAgICAgb25VcGRhdGVDYWxsYmFjaygpXG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBzZXRGaWVsZCA9IDxYUGF0aCBleHRlbmRzIFR5cGVzLlV0aWxpdHkuSlNPTlBhdGg8VHlwZXMuQXJyYXkuT2Y8VD4+PihcbiAgICAgICAgICAgIGZpZWxkOiBUeXBlcy5BcnJheS5Tb3J0LkZpZWxkPFQsIFhQYXRoPiB8IHVuZGVmaW5lZFxuICAgICAgICApID0+IHtcbiAgICAgICAgICAgIGlmICghR3VhcmRzLmlzVW5kZWZpbmVkKGZpZWxkKSkge1xuICAgICAgICAgICAgICAgIHN0YXRlLl9maWVsZCA9IGZpZWxkXG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBzZXRPcmRlciA9IDxYUGF0aCBleHRlbmRzIFR5cGVzLlV0aWxpdHkuSlNPTlBhdGg8VHlwZXMuQXJyYXkuT2Y8VD4+PihcbiAgICAgICAgICAgIGZpZWxkOiBUeXBlcy5BcnJheS5Tb3J0LkZpZWxkPFQsIFhQYXRoPiB8IHVuZGVmaW5lZCxcbiAgICAgICAgICAgIG5vVXBkYXRlT3JkZXJGYWxzeUVxdWFsWFBhdGg6IGJvb2xlYW5cbiAgICAgICAgKSA9PiB7XG4gICAgICAgICAgICBsZXQgaXM6IGJvb2xlYW4gPSBmYWxzZVxuXG4gICAgICAgICAgICBpZiAobm9VcGRhdGVPcmRlckZhbHN5RXF1YWxYUGF0aCkge1xuICAgICAgICAgICAgICAgIGlmIChHdWFyZHMuaXNTdHJpbmcoc3RhdGUuX2ZpZWxkKSAmJiBHdWFyZHMuaXNTdHJpbmcoZmllbGQpKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5fZmllbGQgPT09IGZpZWxkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpcyA9IHRydWUgJiYgY2FsbGVkXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKEd1YXJkcy5pc1N0cmluZyhzdGF0ZS5fZmllbGQpICYmIEd1YXJkcy5pc09iamVjdChmaWVsZCkpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLl9maWVsZCA9PT0gZmllbGQueHBhdGgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlzID0gdHJ1ZSAmJiBjYWxsZWRcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoR3VhcmRzLmlzT2JqZWN0KHN0YXRlLl9maWVsZCkgJiYgR3VhcmRzLmlzU3RyaW5nKGZpZWxkKSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoc3RhdGUuX2ZpZWxkLnhwYXRoID09PSBmaWVsZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaXMgPSB0cnVlICYmIGNhbGxlZFxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChHdWFyZHMuaXNPYmplY3Qoc3RhdGUuX2ZpZWxkKSAmJiBHdWFyZHMuaXNPYmplY3QoZmllbGQpKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5fZmllbGQueHBhdGggPT09IGZpZWxkLnhwYXRoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpcyA9IHRydWUgJiYgY2FsbGVkXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGlzID0gdHJ1ZSAmJiBjYWxsZWRcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKGlzKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgbGFzdE9yZGVySW5kZXggPSBzdGF0ZS5fb3JkZXJzLmxlbmd0aCAtIDFcbiAgICAgICAgICAgICAgICBjb25zdCBjdXJyZW50T3JkZXJJbmRleCA9IHN0YXRlLl9vcmRlcnMuaW5kZXhPZihzdGF0ZS5fb3JkZXIpXG4gICAgICAgICAgICAgICAgY29uc3QgbmV4dE9yZGVySW5kZXggPSBjdXJyZW50T3JkZXJJbmRleCArIDFcbiAgICAgICAgICAgICAgICBzdGF0ZS5fb3JkZXIgPVxuICAgICAgICAgICAgICAgICAgICBuZXh0T3JkZXJJbmRleCA8PSBsYXN0T3JkZXJJbmRleFxuICAgICAgICAgICAgICAgICAgICAgICAgPyBzdGF0ZS5fb3JkZXJzW25leHRPcmRlckluZGV4XVxuICAgICAgICAgICAgICAgICAgICAgICAgOiBzdGF0ZS5fb3JkZXJzWzBdXG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCB1cGRhdGUgPSA8WFBhdGggZXh0ZW5kcyBUeXBlcy5VdGlsaXR5LkpTT05QYXRoPFR5cGVzLkFycmF5Lk9mPFQ+Pj4oXG4gICAgICAgICAgICBvcHRpb25zOiBUeXBlcy5BcnJheS5Tb3J0LlVwZGF0ZU9wdGlvbnM8VCwgWFBhdGg+ID0ge31cbiAgICAgICAgKSA9PiB7XG4gICAgICAgICAgICBjb25zdCB7IGZpZWxkLCBub1VwZGF0ZU9yZGVyRmFsc3lFcXVhbFhQYXRoID0gZmFsc2UgfSA9IG9wdGlvbnNcblxuICAgICAgICAgICAgc2V0T3JkZXIoZmllbGQsIG5vVXBkYXRlT3JkZXJGYWxzeUVxdWFsWFBhdGgpXG5cbiAgICAgICAgICAgIHNldEZpZWxkKGZpZWxkKVxuXG4gICAgICAgICAgICBpZiAoc3RhdGUuX29yZGVyID09PSAnZGVmYXVsdCcpIHtcbiAgICAgICAgICAgICAgICBzdGF0ZS5fY29sbGVjdGlvbiA9IFsuLi5jb2xsZWN0aW9uXSBhcyBUXG4gICAgICAgICAgICAgICAgb25VcGRhdGVDYWxsYmFjaygpXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHN0YXRlLl9jb2xsZWN0aW9uID0gc3RhdGUuX2NvbGxlY3Rpb24uc29ydCgobCwgcikgPT5cbiAgICAgICAgICAgICAgICAgICAgZ2V0Q29tcGFyZUZ1bmN0aW9uKFxuICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUuX29yZGVyIGFzIEV4Y2x1ZGU8VHlwZXMuQXJyYXkuU29ydC5PcmRlciwgJ2RlZmF1bHQnPixcbiAgICAgICAgICAgICAgICAgICAgICAgIGdldFZhbHVlKGwpLFxuICAgICAgICAgICAgICAgICAgICAgICAgZ2V0VmFsdWUocilcbiAgICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICBvblVwZGF0ZUNhbGxiYWNrKClcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghY2FsbGVkKSB7XG4gICAgICAgICAgICB1cGRhdGUoe1xuICAgICAgICAgICAgICAgIGZpZWxkLFxuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIGNhbGxlZCA9IHRydWVcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBjbGVhbnVwLFxuICAgICAgICAgICAgdXBkYXRlLFxuICAgICAgICB9XG4gICAgfVxuXG5leHBvcnQgeyBjcmVhdGVTb3J0IH1cbiJdfQ==
