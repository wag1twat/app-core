"use strict";var __importDefault=function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.createSort=void 0;const Types_1=require("../../Types"),Guards_1=require("../../../Guards"),get_xpath_1=__importDefault(require("../../Object/get-xpath")),get_compare_function_1=__importDefault(require("./get-compare-function")),createSort=f=>e=>{let t=!1;const{field:r,order:d,orders:_,onUpdate:s}=e,a={_collection:f,_order:d||Types_1.Types.Array.Sort.defaultOrder,_orders:_||Types_1.Types.Array.Sort.defaultOrders,_field:r||void 0},i=()=>{Guards_1.Guards.isFunc(s)&&s(a)},o=e=>Guards_1.Guards.isString(a._field)?e[a._field]:Guards_1.Guards.isObject(a._field)?a._field.handler((0,get_xpath_1.default)(e)(a._field.xpath)):e;const u=e=>{Guards_1.Guards.isUndefined(e)||(a._field=e)},l=(e,r)=>{let d=!1;r?Guards_1.Guards.isString(a._field)&&Guards_1.Guards.isString(e)?a._field===e&&(d=t):Guards_1.Guards.isString(a._field)&&Guards_1.Guards.isObject(e)?a._field===e.xpath&&(d=t):Guards_1.Guards.isObject(a._field)&&Guards_1.Guards.isString(e)?a._field.xpath===e&&(d=t):Guards_1.Guards.isObject(a._field)&&Guards_1.Guards.isObject(e)&&a._field.xpath===e.xpath&&(d=t):d=t,d&&(r=a._orders.length-1,e=a._orders.indexOf(a._order)+1,a._order=e<=r?a._orders[e]:a._orders[0])};e=(e={})=>{var{field:e,noUpdateOrderFalsyEqualXPath:r=!1}=e;l(e,r),u(e),"default"===a._order?a._collection=f:a._collection=a._collection.sort((e,r)=>(0,get_compare_function_1.default)(a._order,o(e),o(r))),i()};return t||(e({field:r}),t=!0),{cleanup:()=>{a._field=r||void 0,a._order=d||Types_1.Types.Array.Sort.defaultOrder,a._orders=_||Types_1.Types.Array.Sort.defaultOrders,a._collection=f,i()},update:e}};exports.createSort=createSort;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkJhc2UvQXJyYXkvY3JlYXRlLXNvcnQvY3JlYXRlLXNvcnQuanMiLCIuLi9zcmMvQmFzZS9BcnJheS9jcmVhdGUtc29ydC9jcmVhdGUtc29ydC50cyJdLCJuYW1lcyI6WyJfX2ltcG9ydERlZmF1bHQiLCJtb2QiLCJfX2VzTW9kdWxlIiwiT2JqZWN0IiwiZGVmaW5lUHJvcGVydHkiLCJleHBvcnRzIiwiY3JlYXRlU29ydCIsIlR5cGVzXzEiLCJyZXF1aXJlIiwiR3VhcmRzXzEiLCJnZXRfeHBhdGhfMSIsImdldF9jb21wYXJlX2Z1bmN0aW9uXzEiLCJjb2xsZWN0aW9uIiwib3B0aW9ucyIsImxldCIsImNhbGxlZCIsImZpZWxkIiwib3JkZXIiLCJvcmRlcnMiLCJvblVwZGF0ZSIsInN0YXRlIiwiX2NvbGxlY3Rpb24iLCJfb3JkZXIiLCJUeXBlcyIsIkFycmF5IiwiU29ydCIsImRlZmF1bHRPcmRlciIsIl9vcmRlcnMiLCJkZWZhdWx0T3JkZXJzIiwiX2ZpZWxkIiwidW5kZWZpbmVkIiwib25VcGRhdGVDYWxsYmFjayIsIkd1YXJkcyIsImlzRnVuYyIsImdldFZhbHVlIiwiaXRlbSIsImlzU3RyaW5nIiwiaXNPYmplY3QiLCJoYW5kbGVyIiwiZGVmYXVsdCIsInhwYXRoIiwic2V0RmllbGQiLCJpc1VuZGVmaW5lZCIsInNldE9yZGVyIiwibm9VcGRhdGVPcmRlckZhbHN5RXF1YWxYUGF0aCIsImlzIiwibGFzdE9yZGVySW5kZXgiLCJsZW5ndGgiLCJuZXh0T3JkZXJJbmRleCIsImluZGV4T2YiLCJ1cGRhdGUiLCJzb3J0IiwibCIsInIiLCJjbGVhbnVwIl0sIm1hcHBpbmdzIjoiQUFBQSxhQUNBLElBQUlBLGdCQUFvRCxTQUFVQyxHQUE5REQsT0FBQUEsR0FBZUMsRUFBSUMsV0FBUUQsRUFBS0QsQ0FBQUEsUUFBZUMsQ0FBSyxDQUV4RCxFQUNBRSxPQUY2Q0MsZUFBV0gsUUFBQUEsYUFBQUEsQ0FBQUEsTUFBQUEsQ0FBQUEsQ0FBQUEsQ0FBQUEsRUFHeERJ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dUMsUUF2RllBLEtBQ1psQyxFQUFNUyxPQUFTYixHQUFnQmMsS0FBQUEsRUFDL0JWLEVBQU1FLE9BQVNMLEdBQWdCVixRQUFBZ0IsTUFBTUMsTUFBTUMsS0FBS0MsYUFDaEROLEVBQU1PLFFBQVVULEdBQWtCWCxRQUFBZ0IsTUFBTUMsTUFBTUMsS0FBS0csY0FDbkRSLEVBQU1DLFlBQWNULEVBQ3BCbUIsRUFBZ0IsQ0FDcEIsRUFrRkltQixPQUFBQSxDQUxBbkMsQ0FPUixFQUVLVixRQUFBQyxXQUFBQSIsImZpbGUiOiJCYXNlL0FycmF5L2NyZWF0ZS1zb3J0L2NyZWF0ZS1zb3J0LmpzIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG52YXIgX19pbXBvcnREZWZhdWx0ID0gKHRoaXMgJiYgdGhpcy5fX2ltcG9ydERlZmF1bHQpIHx8IGZ1bmN0aW9uIChtb2QpIHtcbiAgICByZXR1cm4gKG1vZCAmJiBtb2QuX19lc01vZHVsZSkgPyBtb2QgOiB7IFwiZGVmYXVsdFwiOiBtb2QgfTtcbn07XG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgXCJfX2VzTW9kdWxlXCIsIHsgdmFsdWU6IHRydWUgfSk7XG5leHBvcnRzLmNyZWF0ZVNvcnQgPSB2b2lkIDA7XG5jb25zdCBUeXBlc18xID0gcmVxdWlyZShcIi4uLy4uL1R5cGVzXCIpO1xuY29uc3QgR3VhcmRzXzEgPSByZXF1aXJlKFwiLi4vLi4vLi4vR3VhcmRzXCIpO1xuY29uc3QgZ2V0X3hwYXRoXzEgPSBfX2ltcG9ydERlZmF1bHQocmVxdWlyZShcIi4uLy4uL09iamVjdC9nZXQteHBhdGhcIikpO1xuY29uc3QgZ2V0X2NvbXBhcmVfZnVuY3Rpb25fMSA9IF9faW1wb3J0RGVmYXVsdChyZXF1aXJlKFwiLi9nZXQtY29tcGFyZS1mdW5jdGlvblwiKSk7XG5jb25zdCBjcmVhdGVTb3J0ID0gKGNvbGxlY3Rpb24pID0+IChvcHRpb25zKSA9PiB7XG4gICAgbGV0IGNhbGxlZCA9IGZhbHNlO1xuICAgIGNvbnN0IHsgZmllbGQsIG9yZGVyLCBvcmRlcnMsIG9uVXBkYXRlIH0gPSBvcHRpb25zO1xuICAgIGNvbnN0IHN0YXRlID0ge1xuICAgICAgICBfY29sbGVjdGlvbjogY29sbGVjdGlvbixcbiAgICAgICAgX29yZGVyOiBvcmRlciA/IG9yZGVyIDogVHlwZXNfMS5UeXBlcy5BcnJheS5Tb3J0LmRlZmF1bHRPcmRlcixcbiAgICAgICAgX29yZGVyczogb3JkZXJzID8gb3JkZXJzIDogVHlwZXNfMS5UeXBlcy5BcnJheS5Tb3J0LmRlZmF1bHRPcmRlcnMsXG4gICAgICAgIF9maWVsZDogZmllbGQgPyBmaWVsZCA6IHVuZGVmaW5lZCxcbiAgICB9O1xuICAgIC8vY2FsbGJhY2tzXG4gICAgY29uc3Qgb25VcGRhdGVDYWxsYmFjayA9ICgpID0+IHtcbiAgICAgICAgaWYgKEd1YXJkc18xLkd1YXJkcy5pc0Z1bmMob25VcGRhdGUpKSB7XG4gICAgICAgICAgICBvblVwZGF0ZShzdGF0ZSk7XG4gICAgICAgIH1cbiAgICB9O1xuICAgIC8vIHV0aWxpdGllc1xuICAgIGNvbnN0IGdldFZhbHVlID0gKGl0ZW0pID0+IHtcbiAgICAgICAgaWYgKEd1YXJkc18xLkd1YXJkcy5pc1N0cmluZyhzdGF0ZS5fZmllbGQpKSB7XG4gICAgICAgICAgICByZXR1cm4gaXRlbVtzdGF0ZS5fZmllbGRdO1xuICAgICAgICB9XG4gICAgICAgIGlmIChHdWFyZHNfMS5HdWFyZHMuaXNPYmplY3Qoc3RhdGUuX2ZpZWxkKSkge1xuICAgICAgICAgICAgcmV0dXJuIHN0YXRlLl9maWVsZC5oYW5kbGVyKCgwLCBnZXRfeHBhdGhfMS5kZWZhdWx0KShpdGVtKShzdGF0ZS5fZmllbGQueHBhdGgpKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gaXRlbTtcbiAgICB9O1xuICAgIGNvbnN0IGNsZWFudXAgPSAoKSA9PiB7XG4gICAgICAgIHN0YXRlLl9maWVsZCA9IGZpZWxkID8gZmllbGQgOiB1bmRlZmluZWQ7XG4gICAgICAgIHN0YXRlLl9vcmRlciA9IG9yZGVyID8gb3JkZXIgOiBUeXBlc18xLlR5cGVzLkFycmF5LlNvcnQuZGVmYXVsdE9yZGVyO1xuICAgICAgICBzdGF0ZS5fb3JkZXJzID0gb3JkZXJzID8gb3JkZXJzIDogVHlwZXNfMS5UeXBlcy5BcnJheS5Tb3J0LmRlZmF1bHRPcmRlcnM7XG4gICAgICAgIHN0YXRlLl9jb2xsZWN0aW9uID0gY29sbGVjdGlvbjtcbiAgICAgICAgb25VcGRhdGVDYWxsYmFjaygpO1xuICAgIH07XG4gICAgY29uc3Qgc2V0RmllbGQgPSAoZmllbGQpID0+IHtcbiAgICAgICAgaWYgKCFHdWFyZHNfMS5HdWFyZHMuaXNVbmRlZmluZWQoZmllbGQpKSB7XG4gICAgICAgICAgICBzdGF0ZS5fZmllbGQgPSBmaWVsZDtcbiAgICAgICAgfVxuICAgIH07XG4gICAgY29uc3Qgc2V0T3JkZXIgPSAoZmllbGQsIG5vVXBkYXRlT3JkZXJGYWxzeUVxdWFsWFBhdGgpID0+IHtcbiAgICAgICAgbGV0IGlzID0gZmFsc2U7XG4gICAgICAgIGlmIChub1VwZGF0ZU9yZGVyRmFsc3lFcXVhbFhQYXRoKSB7XG4gICAgICAgICAgICBpZiAoR3VhcmRzXzEuR3VhcmRzLmlzU3RyaW5nKHN0YXRlLl9maWVsZCkgJiYgR3VhcmRzXzEuR3VhcmRzLmlzU3RyaW5nKGZpZWxkKSkge1xuICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5fZmllbGQgPT09IGZpZWxkKSB7XG4gICAgICAgICAgICAgICAgICAgIGlzID0gdHJ1ZSAmJiBjYWxsZWQ7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSBpZiAoR3VhcmRzXzEuR3VhcmRzLmlzU3RyaW5nKHN0YXRlLl9maWVsZCkgJiYgR3VhcmRzXzEuR3VhcmRzLmlzT2JqZWN0KGZpZWxkKSkge1xuICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5fZmllbGQgPT09IGZpZWxkLnhwYXRoKSB7XG4gICAgICAgICAgICAgICAgICAgIGlzID0gdHJ1ZSAmJiBjYWxsZWQ7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSBpZiAoR3VhcmRzXzEuR3VhcmRzLmlzT2JqZWN0KHN0YXRlLl9maWVsZCkgJiYgR3VhcmRzXzEuR3VhcmRzLmlzU3RyaW5nKGZpZWxkKSkge1xuICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5fZmllbGQueHBhdGggPT09IGZpZWxkKSB7XG4gICAgICAgICAgICAgICAgICAgIGlzID0gdHJ1ZSAmJiBjYWxsZWQ7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSBpZiAoR3VhcmRzXzEuR3VhcmRzLmlzT2JqZWN0KHN0YXRlLl9maWVsZCkgJiYgR3VhcmRzXzEuR3VhcmRzLmlzT2JqZWN0KGZpZWxkKSkge1xuICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5fZmllbGQueHBhdGggPT09IGZpZWxkLnhwYXRoKSB7XG4gICAgICAgICAgICAgICAgICAgIGlzID0gdHJ1ZSAmJiBjYWxsZWQ7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgaXMgPSB0cnVlICYmIGNhbGxlZDtcbiAgICAgICAgfVxuICAgICAgICBpZiAoaXMpIHtcbiAgICAgICAgICAgIGNvbnN0IGxhc3RPcmRlckluZGV4ID0gc3RhdGUuX29yZGVycy5sZW5ndGggLSAxO1xuICAgICAgICAgICAgY29uc3QgY3VycmVudE9yZGVySW5kZXggPSBzdGF0ZS5fb3JkZXJzLmluZGV4T2Yoc3RhdGUuX29yZGVyKTtcbiAgICAgICAgICAgIGNvbnN0IG5leHRPcmRlckluZGV4ID0gY3VycmVudE9yZGVySW5kZXggKyAxO1xuICAgICAgICAgICAgc3RhdGUuX29yZGVyID1cbiAgICAgICAgICAgICAgICBuZXh0T3JkZXJJbmRleCA8PSBsYXN0T3JkZXJJbmRleFxuICAgICAgICAgICAgICAgICAgICA/IHN0YXRlLl9vcmRlcnNbbmV4dE9yZGVySW5kZXhdXG4gICAgICAgICAgICAgICAgICAgIDogc3RhdGUuX29yZGVyc1swXTtcbiAgICAgICAgfVxuICAgIH07XG4gICAgY29uc3QgdXBkYXRlID0gKG9wdGlvbnMgPSB7fSkgPT4ge1xuICAgICAgICBjb25zdCB7IGZpZWxkLCBub1VwZGF0ZU9yZGVyRmFsc3lFcXVhbFhQYXRoID0gZmFsc2UgfSA9IG9wdGlvbnM7XG4gICAgICAgIHNldE9yZGVyKGZpZWxkLCBub1VwZGF0ZU9yZGVyRmFsc3lFcXVhbFhQYXRoKTtcbiAgICAgICAgc2V0RmllbGQoZmllbGQpO1xuICAgICAgICBpZiAoc3RhdGUuX29yZGVyID09PSAnZGVmYXVsdCcpIHtcbiAgICAgICAgICAgIHN0YXRlLl9jb2xsZWN0aW9uID0gY29sbGVjdGlvbjtcbiAgICAgICAgICAgIG9uVXBkYXRlQ2FsbGJhY2soKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIHN0YXRlLl9jb2xsZWN0aW9uID0gc3RhdGUuX2NvbGxlY3Rpb24uc29ydCgobCwgcikgPT4gKDAsIGdldF9jb21wYXJlX2Z1bmN0aW9uXzEuZGVmYXVsdCkoc3RhdGUuX29yZGVyLCBnZXRWYWx1ZShsKSwgZ2V0VmFsdWUocikpKTtcbiAgICAgICAgICAgIG9uVXBkYXRlQ2FsbGJhY2soKTtcbiAgICAgICAgfVxuICAgIH07XG4gICAgaWYgKCFjYWxsZWQpIHtcbiAgICAgICAgdXBkYXRlKHtcbiAgICAgICAgICAgIGZpZWxkLFxuICAgICAgICB9KTtcbiAgICAgICAgY2FsbGVkID0gdHJ1ZTtcbiAgICB9XG4gICAgcmV0dXJuIHtcbiAgICAgICAgY2xlYW51cCxcbiAgICAgICAgdXBkYXRlLFxuICAgIH07XG59O1xuZXhwb3J0cy5jcmVhdGVTb3J0ID0gY3JlYXRlU29ydDtcbiIsImltcG9ydCB7IFR5cGVzIH0gZnJvbSAnLi4vLi4vVHlwZXMnXG5pbXBvcnQgeyBHdWFyZHMgfSBmcm9tICcuLi8uLi8uLi9HdWFyZHMnXG5pbXBvcnQgZ2V0WFBhdGggZnJvbSAnLi4vLi4vT2JqZWN0L2dldC14cGF0aCdcbmltcG9ydCBnZXRDb21wYXJlRnVuY3Rpb24gZnJvbSAnLi9nZXQtY29tcGFyZS1mdW5jdGlvbidcblxuY29uc3QgY3JlYXRlU29ydCA9XG4gICAgPFQgZXh0ZW5kcyBhbnlbXT4oY29sbGVjdGlvbjogVCkgPT5cbiAgICA8WFBhdGggZXh0ZW5kcyBUeXBlcy5VdGlsaXR5LkpTT05QYXRoPFR5cGVzLkFycmF5Lk9mPFQ+Pj4oXG4gICAgICAgIG9wdGlvbnM6IFR5cGVzLkFycmF5LlNvcnQuT3B0aW9uczxULCBYUGF0aD5cbiAgICApID0+IHtcbiAgICAgICAgbGV0IGNhbGxlZDogYm9vbGVhbiA9IGZhbHNlXG5cbiAgICAgICAgY29uc3QgeyBmaWVsZCwgb3JkZXIsIG9yZGVycywgb25VcGRhdGUgfSA9IG9wdGlvbnNcblxuICAgICAgICBjb25zdCBzdGF0ZTogVHlwZXMuQXJyYXkuU29ydC5TdGF0ZTxUPiA9IHtcbiAgICAgICAgICAgIF9jb2xsZWN0aW9uOiBjb2xsZWN0aW9uLFxuICAgICAgICAgICAgX29yZGVyOiBvcmRlciA/IG9yZGVyIDogVHlwZXMuQXJyYXkuU29ydC5kZWZhdWx0T3JkZXIsXG4gICAgICAgICAgICBfb3JkZXJzOiBvcmRlcnMgPyBvcmRlcnMgOiBUeXBlcy5BcnJheS5Tb3J0LmRlZmF1bHRPcmRlcnMsXG4gICAgICAgICAgICBfZmllbGQ6IGZpZWxkID8gZmllbGQgOiB1bmRlZmluZWQsXG4gICAgICAgIH1cblxuICAgICAgICAvL2NhbGxiYWNrc1xuICAgICAgICBjb25zdCBvblVwZGF0ZUNhbGxiYWNrID0gKCkgPT4ge1xuICAgICAgICAgICAgaWYgKEd1YXJkcy5pc0Z1bmMob25VcGRhdGUpKSB7XG4gICAgICAgICAgICAgICAgb25VcGRhdGUoc3RhdGUpXG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgLy8gdXRpbGl0aWVzXG4gICAgICAgIGNvbnN0IGdldFZhbHVlID0gKGl0ZW06IFR5cGVzLkFycmF5Lk9mPFQ+KSA9PiB7XG4gICAgICAgICAgICBpZiAoR3VhcmRzLmlzU3RyaW5nKHN0YXRlLl9maWVsZCkpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gaXRlbVtzdGF0ZS5fZmllbGRdXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoR3VhcmRzLmlzT2JqZWN0KHN0YXRlLl9maWVsZCkpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gc3RhdGUuX2ZpZWxkLmhhbmRsZXIoZ2V0WFBhdGgoaXRlbSkoc3RhdGUuX2ZpZWxkLnhwYXRoKSlcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBpdGVtXG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBjbGVhbnVwID0gKCkgPT4ge1xuICAgICAgICAgICAgc3RhdGUuX2ZpZWxkID0gZmllbGQgPyBmaWVsZCA6IHVuZGVmaW5lZFxuICAgICAgICAgICAgc3RhdGUuX29yZGVyID0gb3JkZXIgPyBvcmRlciA6IFR5cGVzLkFycmF5LlNvcnQuZGVmYXVsdE9yZGVyXG4gICAgICAgICAgICBzdGF0ZS5fb3JkZXJzID0gb3JkZXJzID8gb3JkZXJzIDogVHlwZXMuQXJyYXkuU29ydC5kZWZhdWx0T3JkZXJzXG4gICAgICAgICAgICBzdGF0ZS5fY29sbGVjdGlvbiA9IGNvbGxlY3Rpb25cbiAgICAgICAgICAgIG9uVXBkYXRlQ2FsbGJhY2soKVxuICAgICAgICB9XG5cbiAgICAgICAgY29uc3Qgc2V0RmllbGQgPSA8WFBhdGggZXh0ZW5kcyBUeXBlcy5VdGlsaXR5LkpTT05QYXRoPFR5cGVzLkFycmF5Lk9mPFQ+Pj4oXG4gICAgICAgICAgICBmaWVsZDogVHlwZXMuQXJyYXkuU29ydC5GaWVsZDxULCBYUGF0aD4gfCB1bmRlZmluZWRcbiAgICAgICAgKSA9PiB7XG4gICAgICAgICAgICBpZiAoIUd1YXJkcy5pc1VuZGVmaW5lZChmaWVsZCkpIHtcbiAgICAgICAgICAgICAgICBzdGF0ZS5fZmllbGQgPSBmaWVsZFxuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgY29uc3Qgc2V0T3JkZXIgPSA8WFBhdGggZXh0ZW5kcyBUeXBlcy5VdGlsaXR5LkpTT05QYXRoPFR5cGVzLkFycmF5Lk9mPFQ+Pj4oXG4gICAgICAgICAgICBmaWVsZDogVHlwZXMuQXJyYXkuU29ydC5GaWVsZDxULCBYUGF0aD4gfCB1bmRlZmluZWQsXG4gICAgICAgICAgICBub1VwZGF0ZU9yZGVyRmFsc3lFcXVhbFhQYXRoOiBib29sZWFuXG4gICAgICAgICkgPT4ge1xuICAgICAgICAgICAgbGV0IGlzOiBib29sZWFuID0gZmFsc2VcblxuICAgICAgICAgICAgaWYgKG5vVXBkYXRlT3JkZXJGYWxzeUVxdWFsWFBhdGgpIHtcbiAgICAgICAgICAgICAgICBpZiAoR3VhcmRzLmlzU3RyaW5nKHN0YXRlLl9maWVsZCkgJiYgR3VhcmRzLmlzU3RyaW5nKGZpZWxkKSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoc3RhdGUuX2ZpZWxkID09PSBmaWVsZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaXMgPSB0cnVlICYmIGNhbGxlZFxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChHdWFyZHMuaXNTdHJpbmcoc3RhdGUuX2ZpZWxkKSAmJiBHdWFyZHMuaXNPYmplY3QoZmllbGQpKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5fZmllbGQgPT09IGZpZWxkLnhwYXRoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpcyA9IHRydWUgJiYgY2FsbGVkXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKEd1YXJkcy5pc09iamVjdChzdGF0ZS5fZmllbGQpICYmIEd1YXJkcy5pc1N0cmluZyhmaWVsZCkpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLl9maWVsZC54cGF0aCA9PT0gZmllbGQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlzID0gdHJ1ZSAmJiBjYWxsZWRcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoR3VhcmRzLmlzT2JqZWN0KHN0YXRlLl9maWVsZCkgJiYgR3VhcmRzLmlzT2JqZWN0KGZpZWxkKSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoc3RhdGUuX2ZpZWxkLnhwYXRoID09PSBmaWVsZC54cGF0aCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaXMgPSB0cnVlICYmIGNhbGxlZFxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBpcyA9IHRydWUgJiYgY2FsbGVkXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChpcykge1xuICAgICAgICAgICAgICAgIGNvbnN0IGxhc3RPcmRlckluZGV4ID0gc3RhdGUuX29yZGVycy5sZW5ndGggLSAxXG4gICAgICAgICAgICAgICAgY29uc3QgY3VycmVudE9yZGVySW5kZXggPSBzdGF0ZS5fb3JkZXJzLmluZGV4T2Yoc3RhdGUuX29yZGVyKVxuICAgICAgICAgICAgICAgIGNvbnN0IG5leHRPcmRlckluZGV4ID0gY3VycmVudE9yZGVySW5kZXggKyAxXG4gICAgICAgICAgICAgICAgc3RhdGUuX29yZGVyID1cbiAgICAgICAgICAgICAgICAgICAgbmV4dE9yZGVySW5kZXggPD0gbGFzdE9yZGVySW5kZXhcbiAgICAgICAgICAgICAgICAgICAgICAgID8gc3RhdGUuX29yZGVyc1tuZXh0T3JkZXJJbmRleF1cbiAgICAgICAgICAgICAgICAgICAgICAgIDogc3RhdGUuX29yZGVyc1swXVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgdXBkYXRlID0gPFhQYXRoIGV4dGVuZHMgVHlwZXMuVXRpbGl0eS5KU09OUGF0aDxUeXBlcy5BcnJheS5PZjxUPj4+KFxuICAgICAgICAgICAgb3B0aW9uczogVHlwZXMuQXJyYXkuU29ydC5VcGRhdGVPcHRpb25zPFQsIFhQYXRoPiA9IHt9XG4gICAgICAgICkgPT4ge1xuICAgICAgICAgICAgY29uc3QgeyBmaWVsZCwgbm9VcGRhdGVPcmRlckZhbHN5RXF1YWxYUGF0aCA9IGZhbHNlIH0gPSBvcHRpb25zXG5cbiAgICAgICAgICAgIHNldE9yZGVyKGZpZWxkLCBub1VwZGF0ZU9yZGVyRmFsc3lFcXVhbFhQYXRoKVxuXG4gICAgICAgICAgICBzZXRGaWVsZChmaWVsZClcblxuICAgICAgICAgICAgaWYgKHN0YXRlLl9vcmRlciA9PT0gJ2RlZmF1bHQnKSB7XG4gICAgICAgICAgICAgICAgc3RhdGUuX2NvbGxlY3Rpb24gPSBjb2xsZWN0aW9uXG4gICAgICAgICAgICAgICAgb25VcGRhdGVDYWxsYmFjaygpXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHN0YXRlLl9jb2xsZWN0aW9uID0gc3RhdGUuX2NvbGxlY3Rpb24uc29ydCgobCwgcikgPT5cbiAgICAgICAgICAgICAgICAgICAgZ2V0Q29tcGFyZUZ1bmN0aW9uKFxuICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUuX29yZGVyIGFzIEV4Y2x1ZGU8VHlwZXMuQXJyYXkuU29ydC5PcmRlciwgJ2RlZmF1bHQnPixcbiAgICAgICAgICAgICAgICAgICAgICAgIGdldFZhbHVlKGwpLFxuICAgICAgICAgICAgICAgICAgICAgICAgZ2V0VmFsdWUocilcbiAgICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICBvblVwZGF0ZUNhbGxiYWNrKClcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghY2FsbGVkKSB7XG4gICAgICAgICAgICB1cGRhdGUoe1xuICAgICAgICAgICAgICAgIGZpZWxkLFxuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIGNhbGxlZCA9IHRydWVcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBjbGVhbnVwLFxuICAgICAgICAgICAgdXBkYXRlLFxuICAgICAgICB9XG4gICAgfVxuXG5leHBvcnQgeyBjcmVhdGVTb3J0IH1cbiJdfQ==
